"""
Italian Learning Companion - Flask Web Application
"""

import sys
import os
import logging
import json
import random
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from pathlib import Path
from flask import Flask, render_template, request, session, redirect, url_for, jsonify, g, flash
import time
from datetime import datetime

# Add src directory to path so we can import existing modules
# Try local src/ first (for deployment), then parent (for development)
current_dir = Path(__file__).parent
if (current_dir / 'src').exists():
    sys.path.insert(0, str(current_dir / 'src'))
else:
    sys.path.insert(0, str(current_dir.parent / 'src'))

from database import ItalianDatabase
from practice_generator import PracticeGenerator

app = Flask(__name__)
# Use environment variable in production, fallback to development key
app.secret_key = os.environ.get('SECRET_KEY', 'italian-learning-companion-secret-key-2024')

# â”€â”€ Error-report email config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Set these as Railway environment variables to enable email reports:
#   REPORT_EMAIL   â€“ where to send reports (your inbox)
#   SMTP_USER      â€“ Gmail address used as sender
#   SMTP_PASSWORD  â€“ Gmail App Password (not your login password)
REPORT_EMAIL  = os.environ.get('REPORT_EMAIL', '')
SMTP_USER     = os.environ.get('SMTP_USER', '')
SMTP_PASSWORD = os.environ.get('SMTP_PASSWORD', '')


def send_error_report(question_text, correct_answer, user_answer,
                      practice_type, level, hint, explanation):
    """Email a mini error report when a user flags a question as wrong/broken.

    Falls back to logging if SMTP credentials are not configured.
    Returns True if email sent, False otherwise.
    """
    timestamp = datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')
    short_q   = question_text[:80] + ('â€¦' if len(question_text) > 80 else '')

    # Always log so it appears in Railway logs even without email
    app.logger.warning(
        f"FLAG_REPORT | q={question_text!r} | correct={correct_answer!r} "
        f"| user={user_answer!r} | type={practice_type} | level={level} "
        f"| hint={hint!r}"
    )

    if not all([REPORT_EMAIL, SMTP_USER, SMTP_PASSWORD]):
        app.logger.info(
            "Email not configured (set REPORT_EMAIL, SMTP_USER, SMTP_PASSWORD). "
            "Report logged to Railway logs only."
        )
        return False

    subject = f"ğŸš© Italian App â€” Error Report: {short_q}"

    plain_body = f"""\
QUESTION FLAGGED AS POSSIBLE ERROR
===================================

Question:       {question_text}
Correct answer: {correct_answer}
User's answer:  {user_answer or '(none)'}

Practice type:  {practice_type}
Level:          {level}
Tense / Hint:   {hint or 'N/A'}
Explanation:    {explanation or 'N/A'}

Flagged at:     {timestamp}
===================================
Please review this question in the app or database.
"""

    def esc(s):
        return str(s).replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;')

    rows = [
        ('Question',       esc(question_text),                       '#f9f9f9'),
        ('Correct answer', f'<span style="color:#059669">{esc(correct_answer)}</span>', '#fff'),
        ('User\'s answer', f'<span style="color:#dc2626">{esc(user_answer or "(none)")}</span>', '#f9f9f9'),
        ('Practice type',  esc(practice_type),                       '#fff'),
        ('Level',          esc(level),                               '#f9f9f9'),
        ('Tense / Hint',   esc(hint or 'N/A'),                       '#fff'),
        ('Explanation',    esc(explanation or 'N/A'),                 '#f9f9f9'),
        ('Flagged at',     esc(timestamp),                           '#fff'),
    ]
    table_rows = ''.join(
        f'<tr style="background:{bg}"><td style="padding:10px;border:1px solid #ddd;'
        f'font-weight:bold;width:140px;vertical-align:top">{label}</td>'
        f'<td style="padding:10px;border:1px solid #ddd">{value}</td></tr>'
        for label, value, bg in rows
    )
    html_body = f"""\
<html><body style="font-family:Arial,sans-serif;max-width:620px;margin:0 auto;padding:20px">
<h2 style="color:#e53e3e">ğŸš© Error Report â€” Italian Learning App</h2>
<table style="width:100%;border-collapse:collapse">{table_rows}</table>
<p style="margin-top:20px;color:#888;font-size:0.85em">
  Auto-generated by Italian Learning Companion.</p>
</body></html>"""

    try:
        msg = MIMEMultipart('alternative')
        msg['Subject'] = subject
        msg['From']    = SMTP_USER
        msg['To']      = REPORT_EMAIL
        msg.attach(MIMEText(plain_body, 'plain'))
        msg.attach(MIMEText(html_body,  'html'))

        with smtplib.SMTP('smtp.gmail.com', 587) as server:
            server.starttls()
            server.login(SMTP_USER, SMTP_PASSWORD)
            server.sendmail(SMTP_USER, REPORT_EMAIL, msg.as_string())

        app.logger.info(f"Error report emailed to {REPORT_EMAIL}")
        return True
    except Exception as exc:
        app.logger.error(f"Failed to send error-report email: {exc}")
        return False


@app.template_filter('parse_conjugate_question')
def parse_conjugate_question(question_text: str) -> dict:
    """
    For conjugation questions, strips the English meaning from the question string
    so it can be rendered as a chip below the answer input instead.
    E.g. "Conjugate 'venire' (to come) in passato prossimo for noi"
      -> main: "Conjugate 'venire' in passato prossimo for noi"
      -> english: "to come"
    Non-conjugation questions are returned unchanged.
    """
    import re
    result = {'main': question_text, 'english': '', 'is_conjugate': False}

    # Only applies to Conjugate questions
    if not re.match(r"Conjugate(?:\s+reflexive)?:", question_text, re.IGNORECASE) and \
       not question_text.startswith("Conjugate '"):
        return result

    result['is_conjugate'] = True

    # Extract and remove the English meaning: (to ...) immediately after the verb name
    eng_match = re.search(r"('\w[\w\s]*')\s*\(([^)]+)\)", question_text)
    if eng_match:
        result['english'] = eng_match.group(2)
        # Rebuild: keep the verb name, drop the (english) part
        question_text = question_text[:eng_match.end(1)] + question_text[eng_match.end():]

    result['main'] = re.sub(r'\s+', ' ', question_text).strip()
    return result

# Configure logging
if not app.debug:
    # Production logging
    handler = logging.StreamHandler()
    handler.setLevel(logging.ERROR)
    formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
    handler.setFormatter(formatter)
    app.logger.addHandler(handler)
    app.logger.setLevel(logging.ERROR)
else:
    # Development logging
    app.logger.setLevel(logging.INFO)

# Database path - use absolute path to avoid path resolution issues
# Try local data/ first (deployment), then parent (development)
if (current_dir / 'data' / 'curriculum.db').exists():
    DB_PATH = str(current_dir / 'data' / 'curriculum.db')
else:
    DB_PATH = str(current_dir.parent / 'data' / 'curriculum.db')

# Simple in-memory cache for static data (vocabulary lists, verb lists)
# Cache expires when app restarts - perfect for static database content
_CACHE = {
    'vocab_by_level': {},
    'verbs_by_level': {},
    'cache_time': None
}


def get_db():
    """Get a database connection for the current request, reusing if available."""
    if 'db' not in g:
        g.db = ItalianDatabase(DB_PATH)
    return g.db


def get_generator():
    """Get a practice generator with the current request's database connection."""
    return PracticeGenerator(get_db())


def get_cached_vocab_count(level: str) -> int:
    """Get vocabulary count for a level from cache or database."""
    if level not in _CACHE['vocab_by_level']:
        db = get_db()
        cursor = db.conn.cursor()
        cursor.execute('SELECT COUNT(*) FROM vocabulary WHERE level = ?', (level,))
        count = cursor.fetchone()[0]
        _CACHE['vocab_by_level'][level] = count
    return _CACHE['vocab_by_level'][level]


def get_cached_verb_count(level: str) -> int:
    """Get verb count for a level from cache or database."""
    # GCSE uses B2 verbs
    query_level = 'B2' if level == 'GCSE' else level

    if query_level not in _CACHE['verbs_by_level']:
        db = get_db()
        cursor = db.conn.cursor()
        cursor.execute('SELECT COUNT(DISTINCT infinitive) FROM verb_conjugations WHERE level = ?', (query_level,))
        count = cursor.fetchone()[0]
        _CACHE['verbs_by_level'][query_level] = count
    return _CACHE['verbs_by_level'][query_level]


@app.teardown_appcontext
def close_db(error):
    """Close the database connection at the end of the request."""
    db = g.pop('db', None)
    if db is not None:
        db.close()


# Constants for validation
VALID_LEVELS = ['A1', 'A2', 'B1', 'B2', 'GCSE']
DEFAULT_QUESTION_COUNT = 10
MIN_QUESTION_COUNT = 1
MAX_QUESTION_COUNT = 50

# Practice type to route mapping for summary page
# Format: practice_type -> (route_name, required_params)
PRACTICE_ROUTES = {
    'vocabulary_quiz': ('vocabulary_quiz', ['level', 'direction']),
    'verb_conjugation': ('verb_conjugation', ['level']),
    'regular_passato': ('regular_passato', ['level']),
    'irregular_passato': ('irregular_passato', ['level']),
    'imperfect_tense': ('imperfect_tense', ['level']),
    'auxiliary_choice': ('auxiliary_choice', ['level']),
    'futuro_semplice': ('futuro_semplice', ['level']),
    'reflexive_verbs': ('reflexive_verbs', ['level']),
    'noun_gender_number': ('noun_gender_number', ['level']),
    'articulated_prepositions': ('articulated_prepositions', ['level']),
    'time_prepositions': ('time_prepositions', ['level']),
    'verb_prepositions': ('verb_prepositions', ['level']),
    'negations': ('negations', ['level']),
    'fill_in_blank': ('fill_in_blank', ['level']),
    'multiple_choice': ('multiple_choice', ['level']),
    'sentence_translation': ('sentence_translator', ['level', 'direction']),
    'present_tense': ('present_tense', ['level']),
    'pronouns': ('pronouns', ['level']),
    'conditional_present': ('conditional_present', ['level']),
    'imperative': ('imperative', ['level']),
    'adverbs': ('adverbs', ['level']),
    'subjunctive_present': ('subjunctive_present', ['level']),
    'pronominal_verbs': ('pronominal_verbs', ['level']),
    'passive_voice': ('passive_voice', ['level']),
    'combined_pronouns': ('combined_pronouns', ['level']),
    'conditional_past': ('conditional_past', ['level']),
    'past_perfect': ('past_perfect', ['level']),
    'subjunctive_past': ('subjunctive_past', ['level']),
    'subjunctive_imperfect': ('subjunctive_imperfect', ['level']),
    'subjunctive_past_perfect': ('subjunctive_past_perfect', ['level']),
    'passato_remoto': ('passato_remoto', ['level']),
    'impersonal_si': ('impersonal_si', ['level']),
    'relative_pronouns': ('relative_pronouns', ['level']),
    'comprehensive_subjunctives': ('comprehensive_subjunctives', ['level']),
    'unreal_past': ('unreal_past', ['level']),
    'unreal_present': ('unreal_present', ['level']),
    'progressive_gerund': ('progressive_gerund', ['level']),
    'causative': ('causative', ['level']),
    'advanced_pronouns': ('advanced_pronouns', ['level']),
    'mixed_tense': ('mixed_tense_drill', ['level']),
    'word_order': ('word_order', ['level']),
    'tense_discrimination': ('tense_discrimination', ['level']),
    'error_correction': ('error_correction', ['level']),
}


def validate_level(level: str) -> str:
    """Validate and return a safe level value."""
    if level not in VALID_LEVELS:
        return 'A2'  # Safe default
    return level


def validate_count(count_str: str) -> int:
    """Validate and return a safe question count."""
    try:
        count = int(count_str)
        if count < MIN_QUESTION_COUNT:
            return MIN_QUESTION_COUNT
        if count > MAX_QUESTION_COUNT:
            return MAX_QUESTION_COUNT
        return count
    except (ValueError, TypeError):
        return DEFAULT_QUESTION_COUNT


def create_practice_route(practice_type: str, generator_method: str, setup_template: str,
                          menu_type: str = 'verbs_menu', requires_level: bool = False):
    """
    Factory function to create standardized practice route handlers.

    Args:
        practice_type: Type identifier for the practice (e.g., 'verb_conjugation')
        generator_method: Name of the method on PracticeGenerator (e.g., 'generate_verb_conjugation_drill')
        setup_template: Template name for the setup page (e.g., 'verb_conjugation_setup.html')
        menu_type: The menu to return to on error (default: 'verbs_menu')
        requires_level: Whether the generator method takes level as first param (default: False)

    Returns:
        A Flask route handler function
    """
    def route_handler():
        level = validate_level(request.args.get('level') or request.form.get('level') or session.get('level', 'A2'))

        if request.method == 'GET':
            session['level'] = level
            return render_template(setup_template, level=level)

        # POST: Start new practice
        count = validate_count(request.form.get('count', 10))
        generator = get_generator()

        # Call the generator method
        method = getattr(generator, generator_method)
        if requires_level:
            questions = method(level, count)
        else:
            questions = method(count)

        # Check if questions were generated
        if not questions or len(questions) == 0:
            session['level'] = level
            return render_template('error.html',
                                 error_message=f"No {practice_type.replace('_', ' ')} exercises available for {level}. Please try a different level.",
                                 back_link=url_for(menu_type, level=level))

        # Store in session
        session['practice_type'] = practice_type
        session['questions'] = questions
        session['current_question'] = 0
        session['correct_count'] = 0
        session['answers'] = []
        session['start_time'] = time.time()
        session['level'] = level

        # SRS mode â€” activated by checkbox on setup page
        srs_mode = request.form.get('srs_mode') == '1'
        session['srs_mode'] = srs_mode
        session['srs_original_count'] = len(questions)
        session['srs_wrong_queue'] = []
        session['srs_injected'] = False

        return redirect(url_for('practice_question'))

    return route_handler


def get_menu_for_practice_type(practice_type: str) -> str:
    """Get the appropriate menu route for a given practice type."""
    verb_types = ['verb_conjugation', 'irregular_passato', 'auxiliary_choice',
                  'imperfect_tense', 'futuro_semplice', 'reflexive_verbs', 'regular_passato',
                  'conditional_present', 'mixed_tense', 'tense_discrimination']
    grammar_types = ['noun_gender_number', 'articulated_prepositions',
                     'time_prepositions', 'negations', 'pronouns', 'adverbs', 'imperative']
    vocabulary_types = ['vocabulary_quiz', 'sentence_translator']
    mixed_types = ['fill_in_blank', 'multiple_choice', 'word_order', 'error_correction']
    reading_types = ['reading_comprehension']

    if practice_type in verb_types:
        return 'verbs_menu'
    elif practice_type in grammar_types:
        return 'grammar_menu'
    elif practice_type in vocabulary_types:
        return 'vocabulary_menu'
    elif practice_type in mixed_types:
        return 'mixed_menu'
    elif practice_type in reading_types:
        return 'reading_menu'
    else:
        return 'category_menu'


def remove_accents(text: str) -> str:
    """Remove Italian accents from text for flexible answer checking."""
    accent_map = {
        'Ã ': 'a', 'Ã¡': 'a',
        'Ã¨': 'e', 'Ã©': 'e',
        'Ã¬': 'i', 'Ã­': 'i',
        'Ã²': 'o', 'Ã³': 'o',
        'Ã¹': 'u', 'Ãº': 'u'
    }

    result = text.lower()
    for accented, plain in accent_map.items():
        result = result.replace(accented, plain)

    return result


def get_etymology_fact(word: str) -> dict:
    """Return a dict {"label": "Etymology"|"Fact", "text": str} for the given word.

    Each entry is either a true etymology (word origin) or a labelled fact.
    When Italian etymology is sparse, English word roots are used and clearly noted.
    """
    # Each value is (label, text).
    # label = "Etymology" for word-origin entries, "Fact" for cultural/language facts,
    #         "English etymology" when we're explaining the English word's origin.
    etymology_facts = {
        # â”€â”€ Days of the week â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'lunedÃ¬':    ('Etymology', 'From Latin "dies Lunae" â€” Moon\'s day. English "Monday" follows the same logic (Old English "mÅnandÃ¦g").'),
        'martedÃ¬':   ('Etymology', 'From Latin "dies Martis" â€” Mars\' day. English "Tuesday" comes from Tiw, the Norse war god â€” a direct swap.'),
        'mercoledÃ¬': ('Etymology', 'From Latin "dies Mercurii" â€” Mercury\'s day. English "Wednesday" comes from Woden (Odin), the Norse equivalent.'),
        'giovedÃ¬':   ('Etymology', 'From Latin "dies Iovis" â€” Jupiter\'s day. English "Thursday" comes from Thor, Norse god of thunder â€” Rome\'s Jupiter.'),
        'venerdÃ¬':   ('Etymology', 'From Latin "dies Veneris" â€” Venus\' day. English "Friday" comes from Frigg (or Freya), the Norse goddess of love.'),
        'sabato':    ('Etymology', 'From Hebrew "Shabbat" (day of rest) â€” one of the few Hebrew loanwords in Italian, entering via early Christian communities.'),
        'domenica':  ('Etymology', 'From Latin "dies dominica" (the Lord\'s day) â€” a Christian renaming. English kept the pagan "Sun\'s day" (Sunday) instead.'),

        # â”€â”€ Months â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'gennaio':   ('Etymology', 'From Latin "Ianuarius" â€” named after Janus, the two-faced god of beginnings and doorways. English "January" is identical in origin.'),
        'febbraio':  ('Etymology', 'From Latin "februum" (a purification ritual) â€” Romans held cleansing rites this month. English "February" has the same root.'),
        'marzo':     ('Etymology', 'Named after Mars, god of war. It was the original first month of the Roman calendar â€” the year began in spring with military campaigns.'),
        'aprile':    ('Etymology', 'Possibly from Latin "aperire" (to open) â€” spring opens the earth. Or from "Aphrodite" via Etruscan. English "April" has the same uncertain root.'),
        'maggio':    ('Etymology', 'From Latin "Maius" â€” named after Maia, goddess of growth and spring. English "May" comes from the same goddess.'),
        'giugno':    ('Etymology', 'From Latin "Iunius" â€” named after Juno, queen of the gods and protector of marriage. English "June" is identical in origin.'),
        'luglio':    ('Etymology', 'From Latin "Iulius" â€” named after Julius Caesar after his death in 44 BC. English "July" honours the same man.'),
        'agosto':    ('Etymology', 'From Latin "Augustus" â€” named after Emperor Augustus in 8 BC. English "August" is the same word.'),
        'settembre': ('Etymology', 'From Latin "septem" (seven) â€” it was the 7th month before January/February were added. "September", "October", "November", "December" all count wrong for the same reason.'),
        'ottobre':   ('Etymology', 'From Latin "octo" (eight) â€” the 8th month of the old Roman calendar. English "October" is identical.'),
        'novembre':  ('Etymology', 'From Latin "novem" (nine) â€” the 9th month of the old Roman calendar. The same root gives us "novena" (nine days of prayer).'),
        'dicembre':  ('Etymology', 'From Latin "decem" (ten) â€” the 10th month of the old Roman calendar. The same root gives English "decimal" and "decade".'),

        # â”€â”€ Seasons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'primavera': ('Etymology', 'From Latin "primo vere" (at the first of spring) â€” literally "the first green shoots". The English "spring" comes from Old English "springan" (to leap up).'),
        'estate':    ('Etymology', 'From Latin "aestas" (summer heat). English "summer" is Germanic in origin â€” one of the few season words Italian and English don\'t share a root for.'),
        'autunno':   ('Etymology', 'From Latin "autumnus" â€” possibly Etruscan in origin, predating Roman Latin entirely. English "autumn" borrowed the Latin form; American "fall" comes from "fall of the leaf".'),
        'inverno':   ('Etymology', 'From Latin "hibernum" (of winter) â€” same root as "hibernate". English "winter" is Germanic, from a root meaning "wet season".'),

        # â”€â”€ Food & drink â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'caffÃ¨':       ('Etymology', 'From Arabic "qahwah" â†’ Turkish "kahve" â†’ Italian. Coffee reached Italy via Venice in the 1570s. The first European coffeehouse opened in Venice in 1645.'),
        'pasta':       ('Etymology', 'From Greek "pastÄ“" (barley porridge). Contrary to the Marco Polo legend, Italians had pasta before his travels. The word "paste" in English has the same Greek root.'),
        'pizza':       ('Fact', 'First documented in a Gaeta Latin text in 997 AD. The Margherita pizza (1889) was named for Queen Margherita of Savoy â€” its red, white and green colours represent the Italian flag.'),
        'pane':        ('Etymology', 'From Latin "panis" â€” also root of English "pantry" and "companion" (com + panis = one who shares bread). The word "pain" in French means bread.'),
        'vino':        ('Etymology', 'From Latin "vinum" â€” one of the oldest cultivated words, shared with Greek "oinos". Italy grows over 350 native grape varieties and produces more wine than any other country.'),
        'acqua':       ('Etymology', 'From Latin "aqua" â€” root of "aquatic", "aquarium", "aqueduct", and "sewer" (via Old French "ewer", water-carrier). Romans built 11 aqueducts supplying Rome with 1 million litres a day.'),
        'latte':       ('Etymology', 'From Latin "lac/lactis" â€” root of "lactose", "lactic", and "galaxy" (the Milky Way, "gala" in Greek, means milk).'),
        'burro':       ('Etymology', 'From Latin "butyrum", from Greek "boutyron" (literally "ox-cheese"). English "butter" has exactly the same Greek root.'),
        'formaggio':   ('Etymology', 'From Latin "formaticus" (made in a mould/forma). French "fromage" comes from the same root. The English word "cheese" is from Latin "caseus" â€” a completely different Latin word.'),
        'gelato':      ('Etymology', 'From Latin "gelatus" (frozen), same root as "gel" and "gelid". Italian gelato contains 25â€“30% less air than American ice cream, making it denser and richer.'),
        'prosciutto':  ('Etymology', 'From Latin "perexsuctum" (thoroughly dried out). The oldest cured ham tradition in Italy dates to the 2nd century BC. Prosciutto di Parma is aged a minimum of 12 months.'),
        'zucchero':    ('Etymology', 'From Arabic "sukkar" via Sanskrit "Å›Ã¡rkarÄ" (gravel or grit, describing sugar crystals). The same Sanskrit root gave English "sugar" via French.'),
        'riso':        ('Etymology', 'From Latin "oryza", from Greek "oryza", ultimately from Sanskrit "vrÄ«hi". English "rice" has the same ancient Indian root via a completely different path.'),
        'pesce':       ('Etymology', 'From Latin "piscis" â€” root of the zodiac sign Pisces, and "piscina" (fish pond â†’ swimming pool). The English "fish" is Germanic, showing how the two languages diverged from common roots.'),
        'carne':       ('Etymology', 'From Latin "caro/carnis" (flesh) â€” root of "carnivore", "carnival" (carne + vale = farewell to meat before Lent), "carnal", and "incarnate".'),
        'uovo':        ('Etymology', 'From Latin "ovum" â€” root of "oval", "ovary", "ovum". The plural is "le uova" â€” one of the few Italian words that changes gender in the plural (un uovo â†’ le uova).'),
        'sale':        ('Etymology', 'From Latin "sal" â€” root of "salary" (Roman soldiers were partly paid in salt, "salarium"), "salad" (salted greens), and "sauce" (salted condiment).'),
        'olio':        ('Etymology', 'From Latin "oleum", from Greek "elaion" (olive oil). Also root of "petroleum" (rock oil) and "linoleum" (linseed oil). English "oil" has the same ultimate Greek root.'),
        'aglio':       ('Etymology', 'From Latin "allium" â€” the scientific genus name for garlic and onions. Romans ate garlic daily for health and strength. The same root gives English "allium".'),
        'pomodoro':    ('Etymology', 'Literally "golden apple" (pomo d\'oro) in Italian â€” early tomatoes brought from South America to Europe were yellow, not red. In German it\'s "Tomate"; in French "tomate" â€” both from the Aztec "tomatl".'),
        'limone':      ('Etymology', 'From Arabic "laymÅ«n" via Persian "lÄ«mÅ«n" â€” citrus fruits spread to Europe through Arab traders. English "lemon" has the same Arabic origin.'),
        'arancia':     ('Etymology', 'From Arabic "nÄranj" via Persian. Italian speakers heard "un naranja" and thought "una rancia" â€” the initial \'n\' migrated to the article! English "orange" has the same Arabic root.'),
        'ananas':      ('Fact', 'From the Tupi word "nanas" (excellent fruit), brought from South America by Portuguese explorers. It\'s called "ananas" in almost every European language except English, which took the name from the Carib word "anana".'),
        'albicocca':   ('Etymology', 'From Arabic "al-barquq" â€” apricots were cultivated in China, spread west via Persia and Arabia. English "apricot" also comes via Arabic, from Latin "praecoquum" (early-ripening).'),
        'fragola':     ('Etymology', 'From Latin "fragrans" (fragrant) â€” named for its sweet smell. English "strawberry" is from Old English "streawberige" â€” the reason for "straw" remains debated.'),
        'uva':         ('Etymology', 'From Latin "uva" (grape cluster). Italy has over 350 native grape varieties â€” more than any other country. English "grape" comes from Germanic "grappa" (hook), referring to the harvesting hook.'),
        'antipasto':   ('Etymology', 'Literally "before the meal" (anti + pasto). The tradition dates to the Roman "gustatio" (tasting course). English "hors d\'oeuvre" means "outside the main work" (oeuvre).'),
        'colazione':   ('Etymology', 'From Latin "collatio" (a bringing together, a contribution). Originally a monastic light meal eaten after prayers. "Breakfast" in English refers to breaking the overnight fast.'),
        'dolce':       ('Etymology', 'From Latin "dulcis" (sweet) â€” root of "dulcet" and "dulcimer" (the sweet instrument). "Dolce vita" means the sweet life. Also used in music to mean "play sweetly".'),
        'birra':       ('Etymology', 'From Germanic "bier" â€” beer was introduced to Italy by northern European tribes (Gauls and Germans). Latin had "cervisia" for beer â€” same root as the Spanish "cerveza".'),
        'cioccolato':  ('Etymology', 'From Aztec Nahuatl "xocolÄtl" (bitter water: xococ = bitter, Ätl = water) â€” brought to Europe by Spanish conquistadors in 1528. England\'s first chocolate house opened in London in 1657.'),
        'pollo':       ('Etymology', 'From Latin "pullus" (young animal) â€” same root as "pullet" (young hen) in English, and "foal" via a Germanic path. Romans raised chickens to read omens before battles.'),
        'verdura':     ('Etymology', 'From Latin "viridis" (green) â€” "verdura" literally means "greenness". English "verdant" (lushly green) has the same root.'),
        'frutta':      ('Etymology', 'From Latin "fructus" (enjoyment, profit, fruit) â€” root of English "fruit", "fructose", and "fruition" (bringing to fruit/fulfilment).'),
        'minestra':    ('Etymology', 'From Latin "ministrare" (to serve) â€” a soup that was "served" to guests. Root of English "minister" (one who serves) and "administer".'),
        'risotto':     ('Fact', 'An Italian invention from the Po Valley â€” rice has been grown in northern Italy since the 15th century. The word is a diminutive of "riso" (rice): little rice.'),
        'mozzarella':  ('Etymology', 'From Neapolitan "mozzare" (to cut off) â€” the cheese is made by cutting and stretching the curd. "Mozzarella di bufala" uses water buffalo milk, which has been farmed in Campania since the 7th century.'),

        # â”€â”€ Animals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'gatto':    ('Etymology', 'From Late Latin "cattus" (4th century AD) â€” a borrowing possibly from a Berber language. The domestic cat was so valued in ancient Rome that stealing one was a serious crime.'),
        'cane':     ('Etymology', 'From Latin "canis" â€” root of "canine", "kennel", and (surprisingly) "cancel" â€” from "cancellare" (to cross out with latticed bars, like a kennel).'),
        'cavallo':  ('Etymology', 'From Latin "caballus" (work horse/nag) â€” root of "cavalry", "cavalier", and "chivalry" (the code of the horse-mounted knight).'),
        'uccello':  ('Etymology', 'From Latin "aucellus" (little bird), itself from "avis" (bird) â€” root of "avian", "aviation", and "augur" (divination by watching bird flight).'),
        'pesce':    ('Etymology', 'From Latin "piscis" â€” root of the zodiac sign Pisces and "piscina" (fish pond, then swimming pool). The English "fish" is Germanic in origin.'),
        'mucca':    ('Fact', '"Mucca" (cow) is an informal Italian word â€” the formal term is "vacca", from Latin "vacca", root of English "vaccine" (early smallpox vaccine used cowpox). English "cow" comes from Old English.'),
        'pecora':   ('Etymology', 'From Latin "pecus" (livestock) â€” root of "peculiar" (originally "one\'s own property") and "pecuniary" (relating to money, from a time when livestock was wealth).'),
        'maiale':   ('Etymology', 'Possibly from the god Maia or from "Majalis" (of May) â€” pigs were sacrificed to Maia in May. English "pig" is Old English; "pork" comes from French "porc", from Latin "porcus" (same root as "porcelain" â€” pig-coloured glaze).'),
        'coniglio':  ('Etymology', 'From Latin "cuniculus" (rabbit or underground passage) â€” rabbits were noted by Romans for burrowing. English "coney" (an archaic word for rabbit) has the same Latin root; "rabbit" itself is of unclear origin.'),
        'topo':     ('English etymology', 'English "mouse" comes from Old English "mÅ«s" â€” related to Sanskrit "mÅ«s" and Latin "mus". The same root gives "muscle" (little mouse) â€” the ripple under the skin was thought to look like a mouse running.'),
        'lupo':     ('Etymology', 'From Latin "lupus" (wolf) â€” root of "lupine" (wolf-like) and the name "Lupercalia" (Roman wolf festival). English "wolf" is Germanic but shares an ancient Proto-Indo-European root with "lupus".'),
        'orso':     ('Etymology', 'From Latin "ursus" (bear) â€” root of "Ursa Major" (Great Bear constellation) and the name "Arthur" (possibly from Celtic "artos", bear). English "bear" is Germanic.'),

        # â”€â”€ Home & places â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'casa':       ('Etymology', 'From Latin "casa" (cottage/hut). In classical Rome, "domus" was the prestigious word for house (root of "domestic", "domain"). "Casa" was the humble word â€” it won out in Italian.'),
        'finestra':   ('Etymology', 'From Latin "fenestra" (window, opening) â€” root of "fenestrated" (having windows) and "defenestration" (throwing someone out of a window â€” a real word with a real history, as in Prague 1618).'),
        'porta':      ('Etymology', 'From Latin "porta" (gate, door) â€” root of "portal", "porter" (gate-keeper), "portfolio" (a case carried through the gate), and "portcullis" (sliding gate).'),
        'cucina':     ('Etymology', 'From Latin "coquina" (kitchen, cooking place) â€” root of "cook", "cuisine", "biscuit" (bi + coctus = twice cooked), and "concoct".'),
        'biblioteca': ('Etymology', 'From Greek "bibliotheke" (book depository): "biblion" (book) + "theke" (chest). The same "biblio-" root gives "bibliography", "Bible" (ta biblia = the books).'),
        'chiesa':     ('Etymology', 'From Greek "ekklesia" (assembly, congregation) â€” root of "ecclesiastical". The original meaning was a citizens\' assembly, not a religious one.'),
        'piazza':     ('Etymology', 'From Latin "platea" (broad street) â€” root of English "place", "plaza", "plate" (flat thing), and "flat" itself via a different path.'),
        'stazione':   ('Etymology', 'From Latin "statio" (a standing, a post) â€” root of "station", "static", "status", "statue", "instant" (standing in the moment), and "understand" (to stand under/among).'),
        'camera':     ('Etymology', 'From Latin "camera" (vaulted room) â€” root of English "chamber", "camera" (a dark vaulted box), and "cameraman". The Italian "camera" means room, not the photographic device.'),
        'bagno':      ('Etymology', 'From Latin "balneum" (bath), from Greek "balaneion". The Romans built extraordinary public baths (thermae); the Baths of Caracalla held 1,600 bathers at once.'),
        'giardino':   ('Etymology', 'From Germanic "gard" (enclosure) â€” root of "garden", "garth", and "yard". The same root gives "regard" (to look over the enclosure) and "guardian".'),
        'tetto':      ('Etymology', 'From Latin "tectum" (roof, covered thing) â€” root of English "detect" (un-cover), "protect" (cover over), and "architect" (chief builder of roofs/structures).'),
        'pavimento':  ('Etymology', 'From Latin "pavimentum" (a beaten/paved floor) â€” root of English "pavement" and "pave". Roman roads were so well paved they lasted 2,000 years.'),
        'muro':       ('Etymology', 'From Latin "murus" (wall) â€” root of "mural" (wall painting) and "immure" (to wall in/imprison). The English word "wall" comes from Latin "vallum" (a defensive rampart).'),
        'soffitto':   ('Etymology', 'From Latin "suffictum" (nailed underneath) â€” the ceiling is the thing fixed under the roof. English "ceiling" comes from Latin "caelum" (sky/heaven) â€” the ceiling as an indoor sky.'),
        'armadio':    ('Etymology', 'From Latin "armarium" (a chest for arms/tools) â€” originally a weapons cabinet, later any wardrobe. English "wardrobe" literally means "guard the robes".'),
        'letto':      ('Etymology', 'From Latin "lectus" (couch, bed) â€” root of "litter" (a portable bed), "lectern" (a reading stand shaped like a resting place), and "lettuce" (originally eaten reclining at table).'),

        # â”€â”€ City & transport â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'treno':      ('Etymology', 'Borrowed from English "train" when railways arrived in Italy in the 1830s. "Train" itself comes from Old French "traÃ¯ner" (to drag/pull).'),
        'aereo':      ('Etymology', 'Short for "aeroplano", from Greek "aer" (air) + Latin "planus" (flat). Italy had pioneering aviators: D\'Annunzio dropped propaganda leaflets over Vienna in 1918.'),
        'autobus':    ('Etymology', 'From Greek "autos" (self) + Latin "omnibus" (for all) â€” literally "self-moving vehicle for everyone". The word "bus" is a clipping of the Latin "omnibus".'),
        'bicicletta': ('Etymology', 'From Latin "bi" (two) + Greek "kyklos" (circle/wheel) + diminutive "-etta". English "bicycle" has the same Greek root. The modern safety bicycle was perfected in the 1880s.'),
        'macchina':   ('Etymology', 'From Greek "mechane" (contrivance, device) â€” Italians called the new automobile "the machine" when it arrived around 1900. Root of "mechanic", "mechanism", "magic" (via a different path).'),
        'nave':       ('Etymology', 'From Latin "navis" (ship) â€” root of "navigate", "navy", "naval", and the "nave" of a church (the ship-shaped central hall).'),
        'porto':      ('Etymology', 'From Latin "portus" (harbour, haven) â€” root of "port", "transport", "import", "export". A port was where you "carried" goods to and from ships.'),
        'passaporto': ('Etymology', 'A compound: "passa" (pass) + "porto" (gate/harbour) â€” a document letting you through the harbour gate. Most European languages use the same logic for passport.'),
        'biglietto':  ('Etymology', 'From French "billet" (note, small document), diminutive of "bille" (a seal on a document). English "billet" (a note, or a soldier\'s lodging order) has the same French root.'),
        'strada':     ('Etymology', 'From Latin "strata via" (paved road) â€” "strata" (laid down in layers) gives English "stratum", "stratosphere", and "street" (all meaning a laid-out path).'),
        'semaforo':   ('Etymology', 'From Greek "sÄ“ma" (sign) + "phoros" (bearer) â€” literally "sign-bearer". The same "sema-" root gives "semantics" (the study of signs/meaning).'),
        'aeroporto':  ('Etymology', '"Aero" (air) + "porto" (harbour) â€” literally "air harbour". The English "airport" uses "air" + "port" (harbour) â€” identical concept, same Latin "portus" root.'),
        'autostrada': ('Fact', 'Italy built the world\'s first motorway (autostrada) in 1924, between Milan and Varese. The word "autostrada" combines "auto" (car) + "strada" (road).'),

        # â”€â”€ People & family â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'madre':   ('Etymology', 'From Latin "mater" (mother) â€” one of the most ancient human words, nearly identical across Indo-European languages: Sanskrit "mÄtr", Greek "mÄ“tÄ“r", English "mother".'),
        'padre':   ('Etymology', 'From Latin "pater" (father) â€” found unchanged in Sanskrit "pitÄ", Greek "patÄ“r", Latin "pater". Root of "patriot", "patron", "patronise", "patrimony".'),
        'fratello':('Etymology', 'From Latin "fraternus" (brotherly) â€” root of "fraternity", "fraternise", and "friar" (a member of a fraternal order). English "brother" is Germanic.'),
        'sorella': ('Etymology', 'From Latin "soror" (sister) â€” root of "sorority". The English "sister" comes from Old Norse "systir". Both trace to a Proto-Indo-European root "swesor".'),
        'figlio':  ('Etymology', 'From Latin "filius" (son) â€” root of "filial" (of or relating to a son/daughter) and "affiliate" (to adopt as a son). English "son" is Germanic.'),
        'nonno':   ('Fact', '"Nonno" (grandfather) is a playful Italian word â€” it likely comes from reduplicated baby-talk ("no-no"). Italian family words often involve this doubling: "mamma", "babbo", "nonna".'),
        'nonna':   ('Fact', 'Like "nonno", "nonna" (grandmother) uses the affectionate doubling common in children\'s Italian. The formal Latin term was "avia" â€” root of "avian" and aviation.'),
        'marito':  ('Etymology', 'From Latin "maritus" (husband) â€” root of "marital", "marriage", "matrimony" (Latin "matrimonium", from "mater" â€” marriage was about the mother\'s rights).'),
        'moglie':  ('Etymology', 'From Latin "mulier" (woman, wife) â€” one of the few cases where Italian departed completely from "femina" (root of "feminine", "female"). "Mulier" is related to "mollis" (soft).'),
        'amico':   ('Etymology', 'From Latin "amicus" (friend) â€” root of "amicable", "amiable", "amity". Interestingly "enemy" comes from "inimicus" (in + amicus = not-friend).'),
        'amica':   ('Etymology', 'Feminine of "amico", from Latin "amica" (female friend). Same root as "amour" (love, intense friendship). The Latin "amare" (to love) is a close relative.'),
        'bambino': ('Etymology', 'From Italian "bambo" (silly/simple) â€” children were called "the simple ones" affectionately. "Il Bambino" is also the classic name for the Christ child in Italian art.'),
        'ragazzo': ('Etymology', 'Uncertain origin â€” possibly from Arabic "raqqÄá¹£" (messenger/courier) via medieval trade routes. English uses "boy" (origin unknown) and "girl" (possibly from Low German "gÃ¶r", small child).'),
        'ragazza': ('Etymology', 'Feminine of "ragazzo". In modern Italian it also means "girlfriend". English "girl" didn\'t originally specify gender â€” in medieval English it meant any young person.'),
        'persona': ('Etymology', 'From Latin "persona" (an actor\'s mask, a character) â€” root of "person", "personal", "personality". The word originally meant the mask that made you a character, not the human behind it.'),
        'gente':   ('Etymology', 'From Latin "gens/gentis" (a clan, race) â€” root of "gentle" (well-born), "gentleman", "gentry", "gentle" and "gentle". "Gentile" originally meant "of a good family".'),
        'popolo':  ('Etymology', 'From Latin "populus" (the people) â€” root of "popular", "population", "public", "republic" (res publica = the public thing). Mussolini\'s "il Popolo d\'Italia" used this word.'),

        # â”€â”€ Body & health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'testa':    ('Etymology', 'From Latin "testa" (a pot or shell) â€” Romans used "caput" for head formally (root of "capital", "captain", "chapter"). "Testa" was slang, like saying "noggin" or "bonce".'),
        'mano':     ('Etymology', 'From Latin "manus" (hand) â€” root of "manual", "manufacture" (make by hand), "manuscript" (written by hand), "manage" (handle), "manoeuvre" (work by hand).'),
        'piede':    ('Etymology', 'From Latin "pes/pedis" (foot) â€” root of "pedestrian", "pedal", "pedestal", "expedition" (freeing the feet to move fast), "impede" (putting the foot in).'),
        'occhio':   ('Etymology', 'From Latin "oculus" (eye) â€” root of "ocular", "binoculars", "inoculate" (to graft into the eye/bud of a plant), and "window" (Old Norse "vindr-auga" = wind-eye).'),
        'naso':     ('Etymology', 'From Latin "nasus" (nose) â€” root of "nasal". Italian "avere il naso fino" means to have sharp intuition (a fine nose). English "nostril" comes from "nose-thirl" (nose-hole).'),
        'cuore':    ('Etymology', 'From Latin "cor/cordis" (heart) â€” root of "cordial" (warm-hearted), "courage" (having heart), "accord" (heart to heart), "record" (put back in the heart), and "discord".'),
        'bocca':    ('Etymology', 'From Latin "bucca" (cheek, mouth) â€” root of "buccal" (relating to the cheek). English "mouth" is Germanic, from Old English "mÅ«Ã¾". The Italian verb "imboccare" means to put food in the mouth.'),
        'orecchio': ('Etymology', 'From Latin "auricula" (little ear) â€” root of "auricular", "aural". English "ear" is Germanic. "Auricle" in English is the outer ear or the ear-shaped chambers of the heart.'),
        'braccio':  ('Etymology', 'From Latin "brachium" (arm, from Greek "brakhion") â€” root of "embrace" (to put in the arms), "brace" (to arm/support). The French "bras" (arm) is a close relative.'),
        'gamba':    ('Etymology', 'From Late Latin "gamba" (hoof, leg) â€” the same root gives the musical instrument "viola da gamba" (played between the legs). French "jambe" and English "gambol" (to skip) share this root.'),
        'schiena':  ('English etymology', 'English "back" comes from Old English "bÃ¦c". Italian "schiena" comes from Germanic "skina" (shin-bone) â€” the spine was likened to a shin-bone. Both Italian and English words have Germanic roots here.'),
        'dente':    ('Etymology', 'From Latin "dens/dentis" (tooth) â€” root of "dental", "dentist", "indent" (to cut like teeth), "dandelion" (dent-de-lion = lion\'s tooth, from the leaf shape).'),
        'capelli':  ('Etymology', 'From Latin "capillus" (hair of the head) â€” root of "capillary" (hair-fine tubes). English "hair" is Germanic. The Italian "capillare" is used in science for hair-thin tubes, just like English.'),
        'febbre':   ('Etymology', 'From Latin "febris" (fever) â€” possibly related to "februum" (purification). English "fever" comes from Old English "fefor" via the same Latin root.'),
        'medicina': ('Etymology', 'From Latin "medicina" â€” the word "doctor" comes from Latin "docere" (to teach); originally a doctor was a learned person. "Medicine" itself may come from "Medica" (Median/Persian herb).'),
        'ospedale': ('Etymology', 'From Latin "hospitale" (a place for guests) â€” root of "hospital", "hotel", "hostel", and "hospitality". All began as places where guests were received.'),
        'farmacia': ('Etymology', 'From Greek "pharmakon" (drug, poison, remedy) â€” root of "pharmacy", "pharmaceutical". In ancient Greek "pharmakon" could mean both a cure and a poison.'),
        'dolore':   ('Etymology', 'From Latin "dolor" (pain, grief) â€” root of "dolorous" (sorrowful), "condolence" (sharing grief). English "dolor" is a rare poetic word for grief.'),

        # â”€â”€ School & learning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'scuola':     ('Etymology', 'From Greek "skholÄ“" â€” the original meaning was "leisure, free time", as only those free from manual work could study. English "school" has the same Greek root via Latin "schola".'),
        'libro':      ('Etymology', 'From Latin "liber" (book, but also the inner bark of a tree â€” where Romans wrote). Root of "library", "libretto" (little book), and "liberate" (a different but homophonous Latin root meaning free).'),
        'lingua':     ('Etymology', 'From Latin "lingua" (tongue, language) â€” root of "bilingual", "linguistics", "language" itself (via Old French), and "linguine" (little tongues, the pasta shape).'),
        'matematica': ('Etymology', 'From Greek "mathÄ“matikÄ“" (the mathematical science) from "manthanein" (to learn) â€” "mathematics" literally means "that which is learned". English "polymath" (one who has learned much) has the same root.'),
        'storia':     ('Etymology', 'From Greek "historia" (inquiry, knowledge gained by investigation) â€” root of "history" and "story" (the same word, diverged in meaning). A "storey" of a building also comes from this root.'),
        'arte':       ('Etymology', 'From Latin "ars/artis" (skill, craft) â€” root of "art", "artisan", "artificial" (made with skill), "article" (a particular thing), and "artillery" (the art of war).'),
        'musica':     ('Etymology', 'From Greek "mousikÄ“" (the art of the Muses) â€” the nine Muses were goddesses of creative arts. Italy gave the world musical notation, the piano, the violin, and opera.'),
        'universitÃ ': ('Fact', 'From Latin "universitas" (a corporation, the whole). The University of Bologna (1088) is the world\'s oldest university. The word "university" referred to a guild of scholars, not to universal knowledge.'),
        'esame':      ('Etymology', 'From Latin "examen" (the tongue of a balance, used for weighing) â€” an exam was a weighing/testing. Root of "examine" and "exact" (precisely weighed). English "exam" is a shortening of the same Latin word.'),
        'penna':      ('Etymology', 'From Latin "penna" (feather, quill) â€” writing quills were made from feathers. Root of "pen", "pennant" (a feather-shaped flag), and the pasta "penne" (quill-shaped tubes).'),
        'quaderno':   ('Etymology', 'From Latin "quaternus" (a set of four) â€” early notebooks were made of four folded sheets (quaternions). English "quire" (25 sheets of paper) has the same root.'),
        'zaino':      ('Etymology', 'From the Turkish "zaino" or dialectal Italian "zaino" â€” possibly from Arabic "za\'in" (a fine thing). English "backpack" is a modern compound; "rucksack" comes from German "RÃ¼cken" (back) + "Sack" (bag).'),
        'classe':     ('Etymology', 'From Latin "classis" (a class of citizens, originally a naval fleet called to assembly) â€” Roman citizens were sorted into "classes" by wealth. Root of "class", "classic", "classify".'),
        'professore': ('Etymology', 'From Latin "professor" (one who publicly declares/teaches) â€” from "profiteri" (to declare openly). Root of "profession" (a declared calling) and "professor".'),

        # â”€â”€ Work â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'lavoro':    ('Etymology', 'From Latin "laborare" (to toil) â€” root of "labour", "elaborate" (worked out carefully), "laboratory" (a place for work/experimentation).'),
        'ufficio':   ('Etymology', 'From Latin "officium" (duty, service, function) â€” root of "official", "officer", "officious" (overly dutiful), and "office". Related to "opus" (work) + "facere" (to do).'),
        'stipendio': ('Fact', 'From Latin "stipendium" (soldiers\' pay) â€” "stips" (small coin) + "pendere" (to weigh/pay). Roman legionaries were paid partly in money, partly in kind. "Soldier" itself comes from "solidus" (a gold coin).'),
        'medico':    ('Etymology', 'From Latin "medicus" (healer) â€” root of "medical", "medicine", "remedy". The word "doctor" comes from Latin "docere" (to teach) â€” early physicians were scholars first.'),
        'ingegnere': ('Etymology', 'From Latin "ingenium" (inborn talent, cleverness) â€” root of "engineer", "engine" (a clever device), "ingenious". English "ingenuity" has the same root.'),
        'avvocato':  ('Etymology', 'From Latin "advocatus" (one called to help, a defender) â€” root of "advocate", "advocation". In law, an advocate was "called" to speak on your behalf.'),
        'architetto':('Etymology', 'From Greek "arkhitekton": "arkhi-" (chief) + "tekton" (builder, craftsman) â€” root of "architect", "architecture", "tectonic" (relating to building/structure).'),
        'cuoco':     ('Etymology', 'From Latin "coquus" (cook) â€” root of "cuisine", "kitchen" (coquina), "biscuit" (twice-cooked), and "cook". English "cook" comes from the same Latin root via Old English.'),
        'poliziotto':('Etymology', 'From "polizia" (police), from Greek "politeia" (city administration, citizenship) â€” root of "policy", "politics", "polite" (all originally about city life and governance).'),
        'pompiere':  ('Etymology', 'From French "pompier" (fireman) â€” originally one who operated the "pompe" (pump). English "fire fighter" is descriptive; "fireman" is the older term.'),

        # â”€â”€ Nature & environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'mare':      ('Etymology', 'From Latin "mare" (sea) â€” root of "marine", "maritime", "submarine", "mariner", and "rosemary" (ros marinus = sea dew, a coastal plant). Italy has 7,600 km of coastline.'),
        'montagna':  ('Etymology', 'From Latin "montanea" (mountainous region) â€” root of "mountain", "Montana" (US state), and "Paramount" (above the mountain = supreme). The Alps are shared by Italy, France, Switzerland, Austria, and Germany.'),
        'fiume':     ('Etymology', 'From Latin "flumen" (river, flow) â€” root of "fluid", "fluent" (flowing speech), "influence" (flowing in), "affluent" (flowing to = wealthy), "superfluous" (overflowing).'),
        'lago':      ('Etymology', 'From Latin "lacus" (lake, basin) â€” root of "lacuna" (a gap, a missing part â€” literally a small lake/pool in a text). English "lake" and "lagoon" also come from this Latin root.'),
        'bosco':     ('Etymology', 'From Germanic "busc" (forest, bush) â€” root of "bush", "ambush" (en + busche = in the bush). Italy\'s forests cover 37% of its land area â€” a higher proportion than most of western Europe.'),
        'sole':      ('Etymology', 'From Latin "sol" (sun) â€” root of "solar", "solstice" (sun + standing still), "parasol" (protection from sun), "solarium". The same Proto-Indo-European root gives English "sun" via Germanic.'),
        'luna':      ('Etymology', 'From Latin "luna" (moon) â€” root of "lunar", "lunatic" (once thought caused by the full moon), "lunacy", "lune" (a crescent shape). English "moon" comes from Germanic "mÅna", same ancient root.'),
        'pioggia':   ('Etymology', 'From Latin "pluvia" (rain) â€” root of "pluvial" (relating to rain), "pluvial period". The origin of Italy\'s name is debated â€” one theory is "Vitalia" (land of cattle), needing good rainfall.'),
        'neve':      ('Etymology', 'From Latin "nix/nivis" (snow) â€” root of "niveous" (snowy-white), "nivation" (erosion by snow). English "snow" is Germanic; "Nevada" (US state) means "snow-covered" in Spanish.'),
        'vento':     ('Etymology', 'From Latin "ventus" (wind) â€” root of "ventilate" (to fan with wind), "vent" (an opening for wind), "inventory" (list of what entered = in + ventus). English "wind" is Germanic.'),
        'terremoto': ('Etymology', 'From Latin "terra" (earth) + "motus" (movement) â€” literally "earth movement". Italy sits on a major fault line; Rome itself has been destroyed and rebuilt many times.'),
        'cielo':     ('Etymology', 'From Latin "caelum" (sky, heaven) â€” root of "celestial" (of the sky), and possibly "ceiling" (the indoor sky). English "sky" is from Old Norse "skÃ½" (cloud).'),
        'stella':    ('Etymology', 'From Latin "stella" (star) â€” root of "stellar", "constellation" (stars grouped together), "interstellar". English "star" is Germanic, sharing an ancient Proto-Indo-European root with "stella".'),
        'pietra':    ('Etymology', 'From Latin "petra" (rock, stone) â€” root of "petrify" (turn to stone), "petroleum" (rock oil), and the name "Peter/Pietro" (given to Simon by Jesus: "on this rock I will build my church").'),
        'sabbia':    ('English etymology', 'English "sand" comes from Old English "sand". Italian "sabbia" comes from Latin "sabulo" (gravel) â€” a different Latin root. Both describe the same ancient material that shapes coastlines.'),
        'foresta':   ('Etymology', 'From Medieval Latin "foresta" (outdoor, unenclosed land) â€” from Latin "foris" (outside, outdoors). Root of "forest" and "foreign" (outside/abroad). An "outforest" was land outside the fenced estate.'),

        # â”€â”€ Clothes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'vestito':  ('Etymology', 'From Latin "vestire" (to clothe) â€” root of "vest", "invest" (to clothe someone in authority), "divest" (to unclothe of power), and "travesty" (a badly dressed impersonation).'),
        'scarpe':   ('Etymology', 'From Germanic "skarpa" (something scraped sharp) â€” shoes were made by scraping and shaping leather. English "shoe" is Old English. "Scarp" (a steep slope) has the same root.'),
        'cappello': ('Etymology', 'From Latin "capa" (hood, cape) â€” root of "cap", "cape" (headland that sticks out like a hood), and "escape" (to slip out of your cape and run). "Chaperon" (a hood/protector) is a French cousin.'),
        'giacca':   ('Etymology', 'From French "jaque" (a short coat or quilted jacket), possibly from "Jacques" â€” the French equivalent of "John", used generically for a peasant. English "jacket" has the same French root.'),
        'pantaloni': ('Fact', 'Named after Pantalone â€” a comic character in Commedia dell\'Arte who wore long trousers. The trousers became so associated with him that they took his name. "Pants" and "pantaloons" in English come from the same character.'),
        'camicia':  ('Etymology', 'From Late Latin "camisia" (shirt, robe) â€” possibly from a Gaulish word. Root of "chemise" (in English/French). "Chemist" (a professional) has a completely different origin from Greek "khÄ“meia" (alchemy).'),
        'calze':    ('Etymology', 'From Latin "calceus" (shoe) from "calx" (heel) â€” root of English "calceolaria" (slipper-shaped flower) and "caulk" (to fill heel-shaped gaps). English "stocking" comes from Old English "stocc" (tree stump/leg).'),
        'cintura':  ('Etymology', 'From Latin "cinctura" (a girding, a belt) â€” root of "cincture" and "precinct" (an area girded/enclosed). English "belt" comes from Old English "belt", from Latin "balteus" (military belt).'),
        'guanti':   ('Etymology', 'From Germanic "wanta" (a glove/mitten) â€” one of the many Germanic words that entered Italian. English "glove" is from Old English "glof". The traditional Italian glove-making city is Naples.'),

        # â”€â”€ Common verbs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'essere':   ('Etymology', 'From two Latin verbs merged: "esse" (to be, giving the forms "Ã¨", "sei") and "sedere" (to sit, giving "sono", "siamo"). That mixing is why the conjugation is so irregular!'),
        'avere':    ('Etymology', 'From Latin "habere" (to have, to hold) â€” root of "habit" (what you habitually hold onto), "inhibit" (hold back), "exhibit" (hold out). English "have" is Germanic.'),
        'fare':     ('Etymology', 'From Latin "facere" (to make, to do) â€” root of "fact" (something made/done), "factory", "affect", "perfect" (completely made), "fashion", "feature", and "feasible".'),
        'andare':   ('Etymology', 'Uncertain origin â€” possibly blended from Latin "ambulare" (to walk: root of "ambulance") and "vadere" (to go). The irregular forms "vado/va/vanno" come from "vadere".'),
        'venire':   ('Etymology', 'From Latin "venire" (to come) â€” root of "advent" (coming), "convention" (coming together), "prevent" (come before), "adventure" (what comes towards you), "revenue" (what comes back).'),
        'dare':     ('Etymology', 'From Latin "dare" (to give) â€” root of "data" (things given), "date" (what was given/agreed), "donation", "render" (give back), "tradition" (what is handed down/given across).'),
        'stare':    ('Etymology', 'From Latin "stare" (to stand) â€” root of "stable", "statue" (standing figure), "state", "station", "instant" (standing in the present moment), "obstacle" (standing in the way).'),
        'sapere':   ('Etymology', 'From Latin "sapere" (to taste, to be wise) â€” root of "savour" (to taste), "sapient" (wise), "sage" (the wise herb), and "Homo sapiens" (wise/knowing human).'),
        'potere':   ('Etymology', 'From Latin "potere" (to be able) â€” root of "potent" (powerful), "possible", "possess" (to be able to sit on = have), "power" via Old French.'),
        'volere':   ('Etymology', 'From Latin "velle/volere" (to wish, to will) â€” root of "voluntary", "volition" (an act of will), "benevolent" (wishing good), "malevolent" (wishing evil).'),
        'dovere':   ('Etymology', 'From Latin "debere" (to owe) â€” root of "debt", "due", "duty". Interestingly "devil" is not related â€” "devil" comes from Greek "diabolos" (the slanderer).'),
        'parlare':  ('Etymology', 'From Latin "parabola" (a parable, a speech) via Greek â€” root of "parliament" (the place of speaking), "parlour" (a speaking room), and "parley" (a discussion with the enemy).'),
        'mangiare': ('Etymology', 'From Latin "manducare" (to chew) â€” root of French "manger" and English "manger" (a feeding trough). The word "mandible" (jaw) has the same root.'),
        'bere':     ('Etymology', 'From Latin "bibere" (to drink) â€” root of "beverage", "imbibe" (to drink in), and "beer" via a different path. English "drink" is Germanic.'),
        'dormire':  ('Etymology', 'From Latin "dormire" â€” root of "dormitory" (sleeping place), "dormant" (sleeping/inactive), "dormouse" (the sleepy mouse). English "sleep" is Germanic.'),
        'studiare': ('Etymology', 'From Latin "studium" (zeal, devoted study) â€” root of "student", "studio" (a place of devoted work), "study", and even "studio apartment" (one-room working space).'),
        'leggere':  ('Etymology', 'From Latin "legere" (to gather, to read) â€” root of "lecture", "legend" (something to be read), "elect" (to gather/choose), "neglect" (not to gather), "intelligent" (choosing between things).'),
        'scrivere': ('Etymology', 'From Latin "scribere" (to write) â€” root of "script", "describe", "prescribe", "subscribe" (write below), "manuscript" (written by hand), and "scribe".'),
        'vedere':   ('Etymology', 'From Latin "videre" (to see) â€” root of "video" (I see), "vision", "evidence" (something clearly seen), "provide" (see ahead for), "supervise" (see from above).'),
        'sentire':  ('Etymology', 'From Latin "sentire" (to feel, to perceive) â€” root of "sense", "sentence" (a judged feeling), "sentiment", "consent" (feel together), "dissent" (feel apart), and "resent" (feel again/back).'),
        'capire':   ('Etymology', 'From Latin "capere" (to grasp, to take) â€” root of "capture", "concept" (grasped together), "capable" (able to grasp), "accept" (take to oneself), "except" (taken out).'),
        'vivere':   ('Etymology', 'From Latin "vivere" (to live) â€” root of "vivid" (lively), "survive" (live beyond), "revive" (live again), "vital", "vitamin" (life-amine), and "vivisection" (cutting while living).'),
        'correre':  ('Etymology', 'From Latin "currere" (to run) â€” root of "current" (running water/electricity), "course", "occur" (run to meet), "corridor" (a running place), and "cursor" (a runner on a screen).'),
        'aprire':   ('Etymology', 'From Latin "aperire" (to open) â€” root of "aperture" (an opening), "aperitif" (opens the appetite), and possibly "April" (the month that opens the earth to spring).'),
        'trovare':  ('Etymology', 'Possibly from Greek "tropos" (a turn/trope) via "tropare" (to compose verse) â€” ProvenÃ§al troubadours "found" melodies. English "troubadour" has the same root.'),
        'chiamare': ('Etymology', 'From Latin "clamare" (to shout, to call) â€” root of "claim", "exclaim", "proclaim", "declaim", and "clamour" (a noisy shouting).'),
        'portare':  ('Etymology', 'From Latin "portare" (to carry) â€” root of "transport" (carry across), "import" (carry in), "export" (carry out), "portfolio" (a case for carrying sheets), "deportment" (how you carry yourself).'),
        'lasciare': ('Etymology', 'From Latin "laxare" (to loosen, to release) â€” root of "lax" (loose/slack), "relax" (loosen again), "lease" (a loosening of property rights), "release".'),
        'pensare':  ('Etymology', 'From Latin "pensare" (to weigh carefully, to ponder) â€” root of "pensive" (deeply thoughtful), "pension" (a weighed-out payment), "compensate" (weigh together to balance), "expense".'),
        'lavorare': ('Etymology', 'From Latin "laborare" (to toil, to work hard) â€” root of "labour", "elaborate" (worked out in detail), "laboratory" (a place for work), and "belabour" (to work over excessively).'),
        'comprare': ('Etymology', 'From Latin "comparare" (to get together, to procure, to compare) â€” related to "compare". English "buy" is Germanic; "purchase" comes from Old French "pourchacier" (to pursue).'),
        'pagare':   ('Etymology', 'From Latin "pacare" (to appease, to satisfy a creditor) â€” root of "pacify", "peace", "appease". Paying a debt was literally "making peace" with your creditor.'),
        'usare':    ('Etymology', 'From Latin "usare/usus" (to use, usage) â€” root of "use", "usual", "abuse" (use wrongly), "refuse" (use back = reject), "peruse" (use through carefully).'),
        'uscire':   ('Etymology', 'From Latin "exire" (to go out) â€” "ex" (out) + "ire" (to go). Root of "exit". The irregular forms (esco, esci) come from the Latin stem "ex-eo".'),
        'partire':  ('Etymology', 'From Latin "partire" (to divide, to depart) â€” root of "part", "department" (divided off section), "compartment", "partner" (sharer of a part), "apartment" (a parted-off dwelling).'),
        'arrivare': ('Etymology', 'From Latin "arripare" (to reach the bank/shore): "ad" (to) + "ripa" (riverbank) â€” literally to reach the riverbank after a journey. Root of "arrive", "arrival", and "river" (from "ripa").'),
        'aiutare':  ('Etymology', 'From Latin "adiutare" (to help, to assist) â€” root of "adjutant" (a military assistant officer). English "help" is Germanic; "aid" comes from the same Latin root via French.'),
        'giocare':  ('Etymology', 'From Latin "iocari" (to jest, to play) â€” root of "joke" and "juggler" (ioculator = a joker/juggler). English "play" is Germanic and also means theatrical performance.'),
        'vincere':  ('Etymology', 'From Latin "vincere" (to conquer, to win) â€” root of "victory", "convince" (conquer intellectually), "invincible" (unconquerable), and the name "Vincent" (conqueror).'),
        'perdere':  ('Etymology', 'From Latin "perdere" (to destroy, to lose utterly) â€” root of "perdition" (utter loss/damnation). English "lose" is Germanic; "loss" comes from Old Norse "los" (breaking up).'),
        'camminare':('Etymology', 'From Latin "caminata" (a walk along a road/caminus) â€” related to "camino" (path). Root of the Camino de Santiago pilgrimage route. English "walk" is Old English; "march" comes from Germanic "markon" (to mark out a path).'),
        'abitare':  ('Etymology', 'From Latin "habitare" (to dwell, to inhabit) â€” root of "habitat" (dwelling place), "inhabit", "habit" (what you dwell in regularly), and "habitual".'),
        'tornare':  ('Etymology', 'From Latin "tornare" (to turn on a lathe, to shape by turning) â€” root of "turn", "tournament" (knights turning/wheeling on horseback), "return" (turn back), "contour" (turned line).'),
        'ricordare':('Etymology', 'From Latin "re + cor/cordis" (back to the heart) â€” to remember is literally "to bring back to the heart". The same root gives "record" (put back in the heart/mind).'),
        'sperare':  ('Etymology', 'From Latin "sperare" (to hope, to expect) â€” root of "desperate" (de + sperare = without hope), "prosper" (for hope = well-wishing), and Esperanto (the language of hope).'),
        'cercare':  ('Etymology', 'From Latin "circare" (to go around, to search) â€” root of "search" and "research" via French, "circa" (around), "circle", and "circus" (a circular arena).'),
        'guardare': ('Etymology', 'From Germanic "wardon" (to watch, to guard) â€” root of "guard", "regard" (look at again), "reward" (look back at/towards), and "ward" (a watched-over area).'),
        'ascoltare':('Etymology', 'From Latin "auscultare" (to listen carefully) â€” root of "auscultation" (the medical technique of listening to the body with a stethoscope â€” literally what doctors do).'),
        'rispondere':('Etymology', 'From Latin "respondere" (to answer, to promise in return): "re" (back) + "spondere" (to pledge). Root of "respond", "response", "responsible" (able to give a pledge back), "sponsor".'),
        'decidere': ('Etymology', 'From Latin "decidere" (to cut off, to decide): "de" (off) + "caedere" (to cut). To decide is to cut off the alternatives. Root of "decide", "decisive", "homicide", and "scissors" (cutting tools).'),
        'chiudere': ('Etymology', 'From Latin "claudere" (to close, to shut) â€” root of "conclude" (close together), "include" (close in), "exclude" (close out), "seclude" (close apart), "closet", and "clause" (a closed sentence).'),
        'credere':  ('Etymology', 'From Latin "credere" (to believe, to trust) â€” root of "credit" (trusted), "creed" (what you believe), "credible", "incredible", "credentials", and "grant" (via Old French "creanter").'),
        'conoscere':('Etymology', 'From Latin "cognoscere" (to get to know): "co" + "gnoscere" (to know). Root of "cognition", "recognise", "incognito" (unknown), and "notice". A different Latin verb "scire" gives "science".'),
        'spiegare': ('Etymology', 'From Latin "explicare" (to unfold, to explain): "ex" (out) + "plicare" (to fold). Root of "explain", "explicit" (fully unfolded), "implicit" (folded in), "complicate" (fold together).'),
        'prendere': ('Etymology', 'From Latin "prehendere" (to seize, to grasp): "pre" (before) + "hendere" (to seize). Root of "comprehend" (grasp completely), "apprehend" (grasp before/towards), "surprise" (seize from above).'),
        'mettere':  ('Etymology', 'From Latin "mittere" (to send, to put) â€” root of "permit" (send through), "submit" (send under), "emit" (send out), "commit" (send with), "promise" (send forward), "message" (what is sent).'),
        'tenere':   ('Etymology', 'From Latin "tenere" (to hold) â€” root of "tenant" (one who holds land), "obtain" (hold towards), "retain" (hold back), "maintain" (hold in the hand), "tenacious" (holding firm), "continent".'),
        'rimanere': ('Etymology', 'From Latin "remanere" (to remain): "re" (back) + "manere" (to stay). Root of "remain", "remnant", "permanent" (staying throughout), "manor" (where one stays), "mansion" (a staying place).'),
        'diventare':('Etymology', 'From Latin "devenire" (to arrive at, to become): "de" + "venire" (to come). Literally "to come to be". English "become" uses a different metaphor: "be" + "come" (to come to be).'),
        'mostrare': ('Etymology', 'From Latin "monstrare" (to show, to point out) â€” root of "demonstrate" (show thoroughly), "monster" (something shown as an omen), "muster" (a show of troops), "remonstrate".'),
        'aspettare':('Etymology', 'From Latin "aspectare" (to watch, to wait for): "ad" + "spectare" (to look). Root of "aspect" (what you look at), "spectacle", "inspector" (one who looks in), "expect" (look out for).'),
        'cambiare': ('Etymology', 'From Late Latin "cambiare" (to exchange) â€” root of "exchange", "change" (via French), and "cambium" (the layer where plant growth happens â€” an exchange of cells).'),
        'preferire': ('Etymology', 'From Latin "praeferre" (to bear before/forward): "prae" (before) + "ferre" (to bear/carry). Root of "prefer", "preference", "fertile" (bearing fruit), "transfer" (bear across), "suffer" (bear under).'),
        'capire':   ('Etymology', 'From Latin "capere" (to grasp) â€” root of "capture", "concept" (grasped together), "capable", "accept", "except", "deceive" (grasp from/away), "participate" (take part).'),
        'finire':   ('Etymology', 'From Latin "finire" (to end, to finish, to define boundaries): from "finis" (boundary, end). Root of "finish", "final", "finite", "infinite", "confine" (set limits), "define" (set the boundary of meaning).'),

        # â”€â”€ Adjectives â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'bello':      ('Etymology', 'From Latin "bellus" (pretty, fine, handsome) â€” root of "belle", "embellish". Completely unrelated to Latin "bellum" (war) despite looking similar.'),
        'buono':      ('Etymology', 'From Latin "bonus" (good) â€” root of "bonus", "boon" (a good thing), "bounty" (goodness), and "bonfire" (originally a "good fire", not a "bone fire" as sometimes claimed).'),
        'grande':     ('Etymology', 'From Latin "grandis" (large, great) â€” root of "grand", "grandeur", "aggrandise" (make bigger). English "great" is Germanic, "grand" is borrowed from French/Latin.'),
        'piccolo':    ('Etymology', 'Uncertain origin, possibly pre-Roman. Now famous worldwide as a small flute (the piccolo). Italian "piccino" (tiny) may be related.'),
        'nuovo':      ('Etymology', 'From Latin "novus" (new) â€” root of "novel" (a new kind of story), "novice" (a new member), "innovation" (making something new), "renovate" (make new again), "November" (ninth, the new month after summer).'),
        'vecchio':    ('Etymology', 'From Latin "vetulus" (elderly, old) â€” root of "veteran" (an old soldier), "inveterate" (deeply ingrained with age). In Italian "vecchio" is often used affectionately, not insultingly.'),
        'lungo':      ('Etymology', 'From Latin "longus" (long) â€” root of "longitude", "elongate", "lounge" (a long relaxed space), "longevity" (long life), "lunge" (a long thrust), and "along".'),
        'alto':       ('Etymology', 'From Latin "altus" (high, deep) â€” root of "altitude", "alto" (the high voice), "exalt" (raise high), and "hauteur" (haughtiness = holding oneself high). Interestingly, Latin "altus" could mean both high above and deep below.'),
        'basso':      ('Etymology', 'From Latin "bassus" (low, stout) â€” root of "bass" (low voice/sound), "bassoon" (a deep woodwind), "abase" (lower), "debase" (lower the value of).'),
        'giovane':    ('Etymology', 'From Latin "iuvenis" (young) â€” root of "juvenile", "rejuvenate" (make young again), and the name "Juvenal" (the Roman satirist). The name "Juventus" (the Turin football club) means youth.'),
        'difficile':  ('Etymology', 'From Latin "difficilis" (not easy): "dis" (not) + "facilis" (easy, doable). Root of "difficult". "Facilis" comes from "facere" (to do) â€” something easy is something that can be done.'),
        'importante': ('Etymology', 'From Latin "importare" (to bring in, to be of consequence): "in" + "portare" (to carry). Something important is "carried in" â€” brought to your attention. Root of both "important" and "import" (to bring goods in).'),
        'simpatico':  ('Fact', '"Simpatico" is a famous false friend! In Italian it means nice/likeable, NOT sympathetic. It comes from Greek "sympathetikos" (feeling together) â€” the meanings have diverged. An Italian "persona simpatica" is a pleasant person.'),
        'morbido':    ('Fact', '"Morbido" is one of the most surprising false friends. In Italian it means SOFT or GENTLE, not morbid. "Morboso" is the Italian for morbid. "Morbido" comes from Latin "morbidus" which originally meant diseased but shifted to mean soft/delicate in Italian.'),
        'bravo':      ('Etymology', 'From Latin "barbarus" (foreign, wild, fierce) via Spanish â€” "bravo" evolved from "fierce" to "bold/skilled". As an exclamation it entered English and many other languages directly from Italian opera audiences.'),
        'furbo':      ('Fact', '"Furbo" (cunning, crafty, clever) is used with a degree of admiration in Italian â€” unlike in English where "cunning" or "sly" is mostly negative. Being "furbo" means knowing how to get things done.'),
        'pronto':     ('Etymology', 'From Latin "promptus" (brought forward, ready) â€” root of "prompt". The English word "prompt" and the Italian stage direction "pronto" (ready!) both come from the same Latin source.'),
        'vero':       ('Etymology', 'From Latin "verus" (true) â€” root of "verify" (make true), "very" (truly), "verdict" (true saying), "verisimilitude" (likeness to truth). "Very" in English originally meant "truly/genuinely".'),
        'libero':     ('Etymology', 'From Latin "liber" (free) â€” root of "liberty", "liberal", "deliver" (set free), "liberate". In Italian football, the "libero" is a free-roaming defender â€” using the same Latin sense.'),
        'povero':     ('Etymology', 'From Latin "pauper" (poor, of few possessions) â€” root of "poor", "poverty", "pauper". English "poor" came via French from the same Latin root.'),
        'ricco':      ('Etymology', 'From Germanic "riks" (powerful, ruler) â€” root of "rich" in English. Both Italian "ricco" and English "rich" come from the same Germanic word meaning powerful before it shifted to mean wealthy.'),
        'stanco':     ('English etymology', 'English "tired" comes from Old English "teorian" (to fail, to become exhausted). Italian "stanco" comes from Germanic "stank" (related to extinguishing, putting out â€” like a fire that\'s gone out from exhaustion).'),
        'sano':       ('Etymology', 'From Latin "sanus" (healthy, sound) â€” root of "sanity", "sanatorium", "sanitary" (promoting health). English "healthy" is Germanic; "sane" is borrowed from the same Latin root.'),
        'freddo':     ('Etymology', 'From Latin "frigidus" (cold) â€” root of "frigid", "refrigerate" (make cold again), and the brand name "Frigidaire". English "cold" is Germanic.'),
        'caldo':      ('Etymology', 'From Latin "calidus" (warm, hot) â€” root of "calorie" (a unit of heat), "cauldron" (a hot pot), "scald" (burn with hot liquid), and "chowder" (via French "chaudiÃ¨re" = hot pot).'),
        'aperto':     ('Etymology', 'Past participle of "aprire" (to open) â€” from Latin "apertus" (open). Root of "aperture" and "aperitif". Used as an adjective meaning open â€” "il negozio Ã¨ aperto" (the shop is open).'),
        'chiuso':     ('Etymology', 'Past participle of "chiudere" (to close) â€” from Latin "clausus" (closed, shut in). Root of "clause" (a closed-off sentence), "claustrophobia" (fear of being closed in), "cloister" (an enclosed space).'),
        'occupato':   ('Etymology', 'From Latin "occupatus" (busy, seized) â€” root of "occupy" (seize and hold), "occupation" (what holds your time), "preoccupy" (take hold of beforehand). On the phone, "Ã¨ occupato" means the line is busy/engaged.'),

        # â”€â”€ Common expressions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'ciao':      ('Etymology', 'From Venetian "s-ciÃ o vostro" (I am your slave/servant) â€” a humble greeting shortened over centuries. Now the world\'s most recognised Italian word, used as both hello and goodbye.'),
        'grazie':    ('Etymology', 'From Latin "gratia" (grace, favour, thanks) â€” root of "gratitude", "gratuitous" (given freely), "congratulate" (wish grace on someone). English "thank you" comes from Germanic "Ã¾ancian" (to think well of).'),
        'prego':     ('Etymology', 'From Latin "precari" (to pray, to beg) â€” used for "you\'re welcome", "please", "go ahead", "after you". One of the most versatile Italian words. Root of "pray", "precarious" (depending on prayer/chance).'),
        'benvenuto': ('Etymology', 'Literally "well come" (bene + venuto) â€” identical structure to English "welcome" (well + come), though "welcome" is Germanic. Both mean "may your coming be well".'),
        'allora':    ('Etymology', 'From Latin "ad illam horam" (at that hour) â€” shortened over centuries to "allora". Now means "so/well/then". One of the most characteristic Italian filler words â€” Italians use it constantly as a conversation opener.'),
        'magari':    ('Etymology', 'From Greek "makÃ¡rios" (blessed, happy) â€” in Italian it expresses wistful hope: "maybe", "if only", "I wish". The Greek root also gives "Macarius" (a saint\'s name meaning blessed).'),
        'purtroppo': ('Etymology', 'Literally "too much" (pur + troppo) â€” evolved to mean "unfortunately". An unusual semantic shift: "it is too much" â†’ "it is regrettably the case". Shows how Italian intensifiers became hedges.'),
        'comunque':  ('Etymology', 'From Latin "quomodo + unque" (in whatever way) â€” means "anyway, however, regardless". One of the most useful Italian connectors, often used at the start of a sentence to change the subject.'),
        'insomma':   ('Etymology', 'From Latin "in summa" (in summary, in the total) â€” means "in short, so, well". Literally "to sum up". English "in short" and "in sum" have the same logical structure.'),
        'davvero':   ('Etymology', 'From Latin "de vero" (from the truth) â€” means "really, truly, indeed". Related to "vero" (true). English "really" has the same logic from "real" (actual/true).'),
        'forse':     ('Etymology', 'From Latin "forsitan" (perhaps, it may be so) â€” from "fors" (luck, chance) and "sit" (may it be). Root of "fortune", "fortuitous" (happening by chance). English "perhaps" means "by chance" from Old Norse.'),
        'giÃ ':       ('Etymology', 'From Latin "iam" (already, now) â€” root of English "just" in the sense of "just now". Italian "giÃ " can mean already, yes, or express surprised recognition.'),
        'ancora':    ('Etymology', 'From Latin "adhuc" (still, yet) via "unquam" (ever) â€” means "still", "yet", "again". Also means the musical direction "encore" â€” literally "still/again". The anchor (Ã ncora with accent shift) is a different word, from Latin "ancora".'),
        'subito':    ('Etymology', 'From Latin "subitus" (sudden, immediate) â€” root of "sudden" via French "soudain". Also a musical direction meaning "suddenly/immediately". Italian "subito!" is the stage manager\'s cry for instant action.'),
        'insieme':   ('Etymology', 'From Latin "in simul" (at the same time, together) â€” "insieme" means together, as a group. Root of "ensemble" (French: playing together) and "simultaneous" (at the same time).'),

        # â”€â”€ Numbers & quantities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'mille':   ('Etymology', 'From Latin "mille" (thousand) â€” root of "mile" (mille passuum = a thousand paces, about 1.5 km), "millennium" (thousand years), "million" (big thousand), and "millimetre".'),
        'cento':   ('Etymology', 'From Latin "centum" (hundred) â€” root of "century" (hundred years), "percent" (per hundred), "centimetre", "centurion" (officer of a hundred soldiers), and "cent" (a hundredth of a dollar).'),
        'numero':  ('Etymology', 'From Latin "numerus" â€” root of "number", "numeral", "innumerable", and "enumerate". English "number" came via French from the same Latin root.'),
        'molto':   ('Etymology', 'From Latin "multum" (much, a great deal) â€” root of "multiply", "multitude", "multiple", "multiform". English "much" is Germanic; "multi-" in compounds comes from the same Latin root.'),
        'poco':    ('Etymology', 'From Latin "paucus" (few, little) â€” root of "pauper" (one with few possessions = poor), "paucity" (scarcity). English "few" is Germanic; "peu" in French shares the same Latin root.'),
        'troppo':  ('Etymology', 'Possibly from Latin "tropus" (a turn/trope â€” too much of a rhetorical turn). In Italian means "too much". Also a musical direction: "allegro ma non troppo" = fast but not too much so.'),
        'abbastanza':('Etymology', 'From Italian "a bastanza" (to sufficiency) â€” from Latin "bastare" (to suffice, to be enough). The same root gives English "bastard" via an unrelated path. "Abbastanza" = enough/quite/rather.'),

        # â”€â”€ Technology & modern â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'computer':   ('Fact', 'English loanword adopted wholesale in the 1950s. Before "computer" took over, Italians used "calcolatore" (calculator/reckoner). The English "computer" originally meant a person who performed calculations.'),
        'telefono':   ('Etymology', 'From Greek "tele" (far) + "phone" (voice) â€” literally "far-voice". Invented by Antonio Meucci, an Italian, who filed a patent caveat in 1871. Bell filed his patent in 1876.'),
        'internet':   ('Fact', 'English compound. Italy was connected to the internet in 1986, one of the earliest European countries. The Italian word "rete" (net/network) comes from Latin "rete" â€” same root as "retina" (the net-like layer of the eye).'),
        'cellulare':  ('Etymology', 'From Latin "cellula" (small room) â€” refers to the "cellular" network of small transmission zones each covering a cell. English "cell phone" uses "cell" in the same technical sense.'),
        'schermo':    ('Etymology', 'From Germanic "skerm" (a shield, a screen) â€” root of "screen" in English. Both the Italian word for screen and the English word come from the same Germanic root meaning a protective barrier.'),
        'tastiera':   ('Etymology', 'From Italian "tasto" (a key, a touch) from Latin "taxare" (to touch, to handle) â€” root of "tax" (an imposed touch/assessment). "Tasto" gives "taste" and "tangible" via different paths.'),

        # â”€â”€ Culture & extras â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'carnevale':  ('Etymology', 'From Latin "carne vale" (farewell to meat) â€” the feast before Lent began, after which meat was forbidden. Venice\'s carnival dates to the 11th century and was once so wild it was held for 6 months a year.'),
        'opera':      ('Etymology', 'From Latin "opus/operis" (a work) â€” literally "a work". Italy invented opera around 1600 in Florence, as artists tried to recreate ancient Greek drama. The word "opera" simply means "the work".'),
        'gondola':    ('Fact', 'Venice has had gondolas since the 11th century. By law they must be painted black (since 1562, to prevent wealth display). There are about 400 gondolas today versus 10,000 at the city\'s peak. The gondolier always stands on the left.'),
        'balcone':    ('Etymology', 'From Italian "balcone" (a large window, a platform) â€” the root of English "balcony". Shakespeare\'s "Romeo and Juliet" (set in Verona) made the word famous worldwide even though "balcony" doesn\'t actually appear in the play.'),
        'ombrello':   ('Etymology', 'From Latin "umbra" (shadow, shade) â€” root of "umbrella" (little shade), "ombre" (shaded colour), "umbrage" (shade/offence â€” taking offence is "being in the shadow"). The umbrella was used for sun protection before rain.'),
        'banca':      ('Etymology', 'From Germanic "bank" (bench) â€” medieval money-changers did business on benches in the marketplace. When a money-changer failed, his bench was broken: "banco rotto" (broken bench) = bankrupt.'),
        'giornale':   ('Etymology', 'From Latin "diurnalis" (daily) â€” root of "journal" (a daily record), "journey" (originally a day\'s travel â€” "journÃ©e"), "journeyman" (paid by the day), and "sojourn" (a day\'s stay).'),
        'campagna':   ('Etymology', 'From Latin "campania" (open flat land) â€” root of "campaign" (military operations in open fields), "champion" (fighter in the open field), "camp". "Campagna Romana" was the open country around Rome.'),
        'festa':      ('Etymology', 'From Latin "festum" (feast, holiday, sacred day) â€” root of "festival", "festive", "feast", "fÃªte" (French party). English "feast" and "fast" (abstaining from feasting) are close relatives.'),
        'violino':    ('Fact', 'From Italian "viola" (a stringed instrument) â€” a diminutive meaning "little viola". Cremona, Italy, is the world capital of violin-making. Stradivari (1644â€“1737) made about 960 instruments; around 650 survive and remain the finest ever made.'),
        'pianoforte': ('Fact', 'Invented by Bartolomeo Cristofori in Florence around 1700 â€” literally "soft-loud" (piano + forte), describing its revolutionary ability to play at varying dynamics, unlike the harpsichord. The full name is "gravicembalo col piano e forte".'),
        'cappuccino': ('Fact', 'Named after the Capuchin friars â€” the drink\'s brown-and-white colour resembles their habits. The Capuchins take their name from the hood (cappuccio) they wear. Capuchin monkeys also get their name from the same hood-like facial colouring.'),
        'paparazzo':  ('Fact', '"Paparazzo" (photographer who pursues celebrities) comes from a character named Paparazzo in Fellini\'s "La Dolce Vita" (1960). Fellini may have taken the name from a Calabrian dialect word for a buzzing insect. The plural "paparazzi" entered English from Italian.'),
        'scenario':   ('Etymology', 'From Italian "scenario" (a scene-by-scene plan for a play) â€” root of English "scenario". "Scena" comes from Latin "scaena" and Greek "skenÄ“" (a tent/stage). Now used worldwide for any hypothetical plan.'),
        'fiasco':     ('Etymology', 'From Italian "fiasco" (a flask, a bottle) â€” the exact path to "complete failure" is disputed, but it may relate to glassblowers discarding imperfect pieces as wine flasks. English borrowed "fiasco" directly from Italian.'),
        'casino':     ('Fact', '"Casino" in Italian means a small house ("casa" + diminutive "-ino"), then a social club or summer house for entertainment. It only means a gambling establishment in the borrowed English sense. An Italian might say "che casino!" (what a mess/chaos!) with no gambling implied.'),
        'graffiti':   ('Etymology', 'From Italian "graffito" (a scratching, an inscription) â€” the plural "graffiti" is now treated as singular in English. From Latin "graphium" (a stylus/writing tool), root of "graph", "paragraph", "photograph" (written with light).'),
        'vendetta':   ('Etymology', 'From Latin "vindicta" (revenge, vengeance) â€” root of "vindicate" (to clear of blame), "vindictive" (revengeful). The word entered English from Italian, evoking southern Italian clan blood-feuds.'),
        'umbrella':   ('Etymology', 'English "umbrella" comes directly from Italian "ombrella" (little shade) â€” from Latin "umbra" (shade). The word "ombre" (the hair colouring technique) has the same root. The umbrella was a sun-shade before a rain-shield.'),
        'lido':       ('Etymology', 'From the Lido di Venezia â€” the narrow sandbar separating Venice\'s lagoon from the Adriatic. "Lido" (beach, open-air pool) entered English via the Venice Lido\'s fame as a fashionable resort in the early 20th century.'),
        'logo':       ('Etymology', 'Short for "logotype" â€” from Greek "logos" (word, reason) + "typos" (impression). "Logo" and "logic" share the same Greek root. In Italian, "logo" means "place" (from Latin "locus") â€” a false friend with a different etymology.'),
        'agenda':     ('Etymology', 'From Latin "agenda" (things to be done) â€” the gerundive of "agere" (to do). Root of "agent" (one who does), "agency", "act". English borrowed the Latin word directly. In Italian, "agenda" simply means a diary/planner.'),
        'corridoio':  ('Etymology', 'From Latin "currere" (to run) â€” a corridor is a running place, a passage for quick movement. English "corridor" borrowed the same word via French. "Current", "occur", and "cursor" all share this "running" root.'),
    }

    # General Italian fun facts shown when no word-specific entry is found
    general_facts = [
        ('Fact', 'Italian is one of the closest living languages to Latin â€” about 89% of Italian words come directly from Latin, compared to about 60% of English vocabulary.'),
        ('Fact', 'Italian is the language of music â€” nearly all musical terms worldwide (allegro, forte, piano, soprano, tempo, aria) are Italian. The system of musical notation was invented by an Italian monk, Guido d\'Arezzo, around 1026 AD.'),
        ('Fact', 'Italy has over 350 distinct pasta shapes, each designed for different sauces and regional traditions. The pairing of sauce to shape is taken seriously â€” spaghetti carbonara, never fusilli carbonara.'),
        ('Fact', 'The first university in the world was the University of Bologna, founded in 1088. It is still operating today, making it the oldest continuously functioning university on Earth.'),
        ('Fact', 'Rome was founded in 753 BC â€” the city is over 2,700 years old. It has been continuously inhabited longer than almost any other city in the world.'),
        ('Fact', 'Italian was the language of the Renaissance â€” da Vinci, Michelangelo, Raphael, Botticelli, Galileo, and Dante all wrote in Italian, and their works shaped Western civilisation.'),
        ('Fact', 'Italian is spoken by about 85 million people worldwide, and is one of the EU\'s 24 official languages. It is also the official language of the Vatican City.'),
        ('Fact', 'Italy only became a unified country in 1861 â€” before that it was a patchwork of kingdoms, city-states, and duchies for over 1,400 years after the fall of Rome.'),
        ('Fact', 'Italy produces more wine than any other country in the world â€” over 5 billion litres per year. The oldest wine region in Italy, Campania, has been producing wine since before Roman times.'),
        ('Fact', 'Italy is home to many of the world\'s top fashion houses: Gucci, Versace, Prada, Armani, Dolce & Gabbana, Fendi, and Valentino are all Italian. Milan is considered one of the four global fashion capitals.'),
        ('Fact', 'Italy built the world\'s first motorway (autostrada) in 1924, between Milan and Varese. The Italian love of cars also produced Ferrari, Lamborghini, Maserati, Alfa Romeo, and Lancia.'),
        ('Fact', 'Italian has two words for "you": "tu" (informal) and "Lei" (formal). The formal "Lei" uses the 3rd person singular â€” a quirk inherited from Renaissance court culture where addressing someone in the 3rd person was a sign of respect.'),
        ('Fact', 'The letters J, K, W, X, and Y do not appear in native Italian words â€” they only appear in foreign loanwords. This is why Italian names avoid these letters entirely.'),
        ('Fact', 'Italy invented Commedia dell\'Arte in the 16th century â€” improvised masked theatre with stock characters. Harlequin, Columbina, and Pantalone are still recognisable character types in comedy today.'),
        ('Fact', 'Italy has more active volcanoes than any other European country: Vesuvius (near Naples), Etna (Sicily), Stromboli (Aeolian Islands), and the Campi Flegrei supervolcano near Naples.'),
        ('Fact', 'Italian has a rich tradition of hand gestures â€” some linguists count over 250 distinct gesture meanings. Gestures can communicate "what do you want?", "perfect!", "I don\'t care", and many more without a word.'),
        ('Fact', 'Dante\'s Divine Comedy (1308â€“1320) did more to standardise Italian than any other single work. Dante chose to write in the Florentine vernacular rather than Latin â€” a revolutionary decision that shaped the Italian language.'),
        ('Fact', 'Italy has won the FIFA World Cup four times (1934, 1938, 1982, 2006) and the UEFA European Championship twice. Football (calcio) is a national obsession â€” the word "calcio" comes from the Florentine game "gioco del calcio" (kicking game).'),
        ('Fact', 'Italy contains more UNESCO World Heritage Sites than any other country â€” 58 as of 2024. This includes the historic centres of Rome, Florence, Venice, and Naples, as well as Pompeii, the Amalfi Coast, and the Dolomites.'),
        ('Fact', 'The Italian language has formal and informal registers that affect verb conjugation, pronouns, and vocabulary. Learning when to switch between "tu" and "Lei" is one of the most culturally important aspects of Italian.'),
    ]

    import random as _random

    # Strip articles and normalise the lookup word
    word_clean = (word.lower()
                  .replace('il ', '').replace('la ', '').replace('i ', '')
                  .replace('le ', '').replace('gli ', '').replace('lo ', '')
                  .replace("l'", '').strip())

    # Direct lookup first
    entry = etymology_facts.get(word_clean)
    if entry:
        return {"label": entry[0], "text": entry[1]}

    # Try the first word only (handles phrases like "fare il bucato")
    first_word = word_clean.split()[0] if ' ' in word_clean else None
    if first_word:
        entry = etymology_facts.get(first_word)
        if entry:
            return {"label": entry[0], "text": entry[1]}

    # Fall back to a random general Italian fact
    entry = _random.choice(general_facts)
    return {"label": entry[0], "text": entry[1]}


def check_answer(user_answer: str, correct_answer: str, question_type: str = None) -> tuple[bool, str]:
    """
    Check if user answer matches the correct answer with flexible matching.

    Returns:
        (is_correct, display_answer) - bool indicating correctness, and the answer to display

    Handles:
    - Accent-forgiving matching
    - Multiple acceptable answers separated by "/" (e.g., "small/low")
    - Optional "to" for verb infinitives (e.g., "to speak" or "speak")
    - Number flexibility (e.g., "27" = "twenty-seven", "3" = "three")
    - Extra whitespace
    - Sentence translation: Very lenient, checks if key words are present
    """
    import re

    # Normalise apostrophe spacing: "l' isola" â†’ "l'isola"
    def _norm(s):
        return re.sub(r"'\s+", "'", remove_accents(s.strip().lower()))
    user_normalized = _norm(user_answer)
    correct_normalized = _norm(correct_answer)

    # Number word to digit mapping
    number_words = {
        'zero': '0', 'one': '1', 'two': '2', 'three': '3', 'four': '4', 'five': '5',
        'six': '6', 'seven': '7', 'eight': '8', 'nine': '9', 'ten': '10',
        'eleven': '11', 'twelve': '12', 'thirteen': '13', 'fourteen': '14', 'fifteen': '15',
        'sixteen': '16', 'seventeen': '17', 'eighteen': '18', 'nineteen': '19', 'twenty': '20',
        'twenty-one': '21', 'twenty-two': '22', 'twenty-three': '23', 'twenty-four': '24',
        'twenty-five': '25', 'twenty-six': '26', 'twenty-seven': '27', 'twenty-eight': '28',
        'twenty-nine': '29', 'thirty': '30', 'forty': '40', 'fifty': '50', 'sixty': '60',
        'seventy': '70', 'eighty': '80', 'ninety': '90', 'hundred': '100'
    }

    # Create reverse mapping (digit to word)
    digit_to_word = {v: k for k, v in number_words.items()}

    # Convert numbers in both user and correct answers
    def normalize_numbers(text):
        """Convert number words to digits for comparison."""
        # Replace number words with digits
        for word, digit in number_words.items():
            text = re.sub(r'\b' + word + r'\b', digit, text)
        return text

    def denormalize_numbers(text):
        """Convert digits to number words for comparison."""
        # Replace digits with number words (sort by length desc to handle 27 before 7)
        for digit in sorted(digit_to_word.keys(), key=len, reverse=True):
            word = digit_to_word[digit]
            text = re.sub(r'\b' + digit + r'\b', word, text)
        return text

    user_with_digits = normalize_numbers(user_normalized)
    correct_with_digits = normalize_numbers(correct_normalized)
    user_with_words = denormalize_numbers(user_normalized)
    correct_with_words = denormalize_numbers(correct_normalized)

    # For sentence translation, use very flexible matching
    if question_type == 'sentence_translation':
        # Remove punctuation from both answers
        import string
        user_no_punct = user_with_digits.translate(str.maketrans('', '', string.punctuation))
        correct_no_punct = correct_with_digits.translate(str.maketrans('', '', string.punctuation))

        # Split into words
        user_words = user_no_punct.split()
        correct_words = correct_no_punct.split()

        # Remove common words that don't affect meaning (expanded list)
        stopwords = {
            'the', 'a', 'an', 'is', 'am', 'are', 'was', 'were', 'be', 'been', 'being',
            'il', 'lo', 'la', 'i', 'gli', 'le', "l'", 'un', 'una', 'uno',
            'di', 'da', 'in', 'con', 'su', 'per', 'tra', 'fra',
            'to', 'at', 'on', 'of', 'from', 'with', 'by', 'for'
        }

        # Keep words that are NOT stopwords
        user_content_words = [w for w in user_words if w not in stopwords]
        correct_content_words = [w for w in correct_words if w not in stopwords]

        # Also check for semantic equivalents
        synonyms = {
            'cinema': ['movies', 'movie', 'theater', 'theatre'],
            'movies': ['cinema', 'movie', 'theater', 'theatre'],
            'movie': ['cinema', 'movies', 'theater', 'theatre'],
            'theater': ['cinema', 'movies', 'movie', 'theatre'],
            'go': ['going', 'went'],
            'went': ['go', 'going'],
            'going': ['go', 'went'],
            'tired': ['sleepy', 'exhausted'],
            'hungry': ['starving'],
            'thirsty': ['parched'],
        }

        # Check matches with synonyms
        matches = 0
        for correct_word in correct_content_words:
            # Direct match
            if correct_word in user_content_words:
                matches += 1
            # Synonym match
            elif correct_word in synonyms:
                if any(syn in user_content_words for syn in synonyms[correct_word]):
                    matches += 1

        # Very lenient: accept if 50% of content words match
        if len(correct_content_words) > 0:
            similarity = matches / len(correct_content_words)

            # Accept if 50% of key words match (lowered from 70%)
            if similarity >= 0.5:
                return True, correct_answer

        # Also accept if user answer contains most of the correct answer
        if len(user_content_words) > 0 and len(correct_content_words) > 0:
            reverse_matches = sum(1 for word in user_content_words if word in correct_content_words or word in str(synonyms.get(word, [])))
            reverse_similarity = reverse_matches / len(user_content_words)
            if reverse_similarity >= 0.6:
                return True, correct_answer

    # For negation transform questions: strip punctuation before comparing (Bug-0118)
    # Users shouldn't fail just because they omitted a period or exclamation mark
    if question_type == 'negation':
        import string as _string
        strip_punct = lambda t: t.translate(str.maketrans('', '', _string.punctuation))
        if strip_punct(user_normalized) == strip_punct(correct_normalized):
            return True, correct_answer

    # Standard matching for other types
    # Split correct answer by "/" or ", " to get all acceptable answers
    # e.g. "under/below" or "under, below" should both accept just "under"
    raw_answers = re.split(r'/|,\s*', correct_answer)
    acceptable_answers = [remove_accents(ans.strip().lower()) for ans in raw_answers]

    # For each acceptable answer, also check variants
    all_acceptable = []
    for ans in acceptable_answers:
        all_acceptable.append(ans)
        # Also add the number-normalized version
        all_acceptable.append(normalize_numbers(ans))

        # If answer starts with "to ", also accept without "to"
        if ans.startswith('to '):
            all_acceptable.append(ans[3:])  # Remove "to "
            all_acceptable.append(normalize_numbers(ans[3:]))
        # If answer doesn't start with "to ", also accept with "to "
        else:
            # Check if this looks like a verb (heuristic: single word, not a noun with article)
            if ' ' not in ans and not ans.startswith(('il ', 'la ', 'i ', 'gli ', 'le ', "l'")):
                all_acceptable.append(f'to {ans}')
                all_acceptable.append(f'to {normalize_numbers(ans)}')

    # Check if user answer matches any acceptable variant (with or without number conversion)
    # Also normalize all acceptable answers for number comparison
    all_acceptable_normalized = []
    for acc in all_acceptable:
        all_acceptable_normalized.append(acc)
        all_acceptable_normalized.append(normalize_numbers(acc))
        all_acceptable_normalized.append(denormalize_numbers(acc))

    is_correct = (user_normalized in all_acceptable_normalized or
                  user_with_digits in all_acceptable_normalized or
                  user_with_words in all_acceptable_normalized)

    # Synonym / near-match check for vocabulary (single words or short phrases)
    # Catches cases like "small" vs "little", "bike" vs "bicycle", etc.
    if not is_correct:
        vocab_synonyms = {
            # Size / degree
            'small': ['little', 'tiny', 'petite'],
            'little': ['small', 'tiny'],
            'big': ['large', 'great'],
            'large': ['big', 'great'],
            # Bike
            'bike': ['bicycle', 'bici'],
            'bicycle': ['bike', 'bici'],
            'bici': ['bicycle', 'bike', 'bicicletta'],
            'bicicletta': ['bike', 'bicycle', 'bici'],
            # Common verb synonyms
            'to go': ['to leave', 'to walk'],
            'to look': ['to watch', 'to see'],
            'to see': ['to look', 'to watch'],
            'to wish': ['to want', 'to desire'],
            'to want': ['to wish', 'to desire'],
            'to speak': ['to talk', 'to say'],
            'to talk': ['to speak', 'to chat'],
            'to listen': ['to hear'],
            'to hear': ['to listen'],
            'to get': ['to obtain', 'to receive', 'to take'],
            'to take': ['to get', 'to grab'],
            'to like': ['to enjoy', 'to love'],
            'to enjoy': ['to like', 'to love'],
            'to begin': ['to start'],
            'to start': ['to begin'],
            'to finish': ['to end', 'to complete'],
            'to end': ['to finish', 'to complete'],
            'to live': ['to reside'],
            'to work': ['to labour', 'to labor'],
            'to wait': ['to wait for'],
            'to wait for': ['to wait'],
            'to know': ['to understand', 'to recognise', 'to recognize'],
            'to understand': ['to know', 'to comprehend'],
            'to help': ['to assist', 'to aid'],
            'to try': ['to attempt'],
            'to walk': ['to go on foot', 'to stroll'],
            # Adjective synonyms
            'beautiful': ['pretty', 'lovely', 'gorgeous'],
            'pretty': ['beautiful', 'lovely'],
            'lovely': ['beautiful', 'pretty'],
            'happy': ['glad', 'joyful', 'pleased'],
            'glad': ['happy', 'pleased'],
            'sad': ['unhappy', 'upset'],
            'tired': ['exhausted', 'sleepy', 'weary'],
            'angry': ['upset', 'annoyed', 'cross'],
            'correct': ['right'],
            'right': ['correct'],
            'wrong': ['incorrect'],
            'incorrect': ['wrong'],
            'fast': ['quick', 'rapid'],
            'quick': ['fast', 'rapid'],
            'slow': ['sluggish'],
            # Noun synonyms
            'mum': ['mom', 'mother', 'mamma'],
            'mom': ['mum', 'mother', 'mamma'],
            'mother': ['mum', 'mom', 'mamma'],
            'dad': ['father', 'papa', 'papÃ '],
            'father': ['dad', 'papa', 'papÃ '],
            'flat': ['apartment'],
            'apartment': ['flat'],
            'shop': ['store', 'negozio'],
            'store': ['shop'],
            'film': ['movie', 'cinema'],
            'movie': ['film', 'cinema'],
            'friend': ['mate', 'pal'],
            # Holiday / vacation
            'holiday': ['vacation', 'holidays'],
            'vacation': ['holiday', 'holidays'],
            'holidays': ['holiday', 'vacation'],
            # Autumn / fall
            'autumn': ['fall'],
            'fall': ['autumn'],
            # Lift / elevator
            'lift': ['elevator'],
            'elevator': ['lift'],
            # Jumper / sweater
            'jumper': ['sweater', 'pullover'],
            'sweater': ['jumper', 'pullover'],
            # Trousers / pants
            'trousers': ['pants'],
            'pants': ['trousers'],
            # Chemist / pharmacy
            'chemist': ['pharmacy', 'pharmacist'],
            'pharmacy': ['chemist', 'drugstore'],
            # Theatre / theater
            'theatre': ['theater'],
            'theater': ['theatre'],
            # Colour / color
            'colour': ['color'],
            'color': ['colour'],
            # Neighbour / neighbor
            'neighbour': ['neighbor'],
            'neighbor': ['neighbour'],
            # Travelling / traveling
            'travelling': ['traveling'],
            'traveling': ['travelling'],
            # Rubbish / garbage / trash
            'rubbish': ['garbage', 'trash'],
            'garbage': ['rubbish', 'trash'],
            'trash': ['rubbish', 'garbage'],
            # Mobile phone / cell phone
            'mobile phone': ['cell phone', 'cellphone', 'mobile'],
            'cell phone': ['mobile phone', 'mobile'],
            'mobile': ['mobile phone', 'cell phone'],
            # Football / soccer
            'football': ['soccer'],
            'soccer': ['football'],
            # Post office / mail
            'post office': ['mail office'],
            # Town hall / city hall
            'town hall': ['city hall'],
            'city hall': ['town hall'],
            # Healthcare noun synonyms
            'illness': ['sickness', 'disease'],
            'sickness': ['illness', 'disease'],
            'disease': ['illness', 'sickness'],
            'stomach ache': ['stomachache', 'stomach pain'],
            'stomachache': ['stomach ache', 'stomach pain'],
            'headache': ['head ache'],
            'toothache': ['tooth ache'],
            # Clever / intelligent / smart
            'clever': ['intelligent', 'smart', 'bright'],
            'intelligent': ['clever', 'smart', 'bright'],
            'smart': ['clever', 'intelligent'],
            # Hardworking / diligent / studious
            'hardworking': ['diligent', 'studious', 'hard-working'],
            'diligent': ['hardworking', 'studious'],
            # Brave / courageous
            'brave': ['courageous', 'bold'],
            'courageous': ['brave', 'bold'],
            # Kind / nice / gentle
            'kind': ['nice', 'gentle', 'caring'],
            'gentle': ['kind', 'nice'],
            # Selfish / self-centred
            'selfish': ['self-centred', 'self-centered'],
            # Shy / timid
            'shy': ['timid', 'bashful'],
            'timid': ['shy', 'bashful'],
        }

        user_strip = user_normalized.lstrip('to ') if user_normalized.startswith('to ') else user_normalized
        user_no_the = user_normalized[4:] if user_normalized.startswith('the ') else user_normalized
        for acc in all_acceptable:
            acc_strip = acc.lstrip('to ') if acc.startswith('to ') else acc
            acc_no_the = acc[4:] if acc.startswith('the ') else acc
            syns = (vocab_synonyms.get(acc, []) +
                    vocab_synonyms.get(acc_no_the, []) +
                    vocab_synonyms.get(f'to {acc_strip}', []))
            # Build a flat set of synonym bare forms for comparison
            syns_no_the = [s[4:] if s.startswith('the ') else s for s in syns]
            if (user_normalized in syns or
                    user_strip in [s.lstrip('to ') for s in syns] or
                    user_no_the in syns_no_the):
                is_correct = True
                break

    # Bug-0125: Accept if user wrote a longer answer that contains all words of
    # the correct answer (e.g. "the beach and the sea" for "the beach")
    if not is_correct:
        correct_words_set = set(correct_normalized.split())
        user_words_set = set(user_normalized.split())
        if correct_words_set and correct_words_set.issubset(user_words_set) and len(user_words_set) > len(correct_words_set):
            is_correct = True

    # For display, use the first option if multiple (handles both "/" and ", " separators)
    display_answer = re.split(r'/|,\s*', correct_answer)[0].strip() if ('/' in correct_answer or ',' in correct_answer) else correct_answer

    return is_correct, display_answer


# ============================================================================
# ERROR HANDLERS
# ============================================================================

@app.errorhandler(404)
def page_not_found(error):
    """Handle 404 errors with user-friendly message."""
    return render_template('error.html',
                          error_message="Page not found. The page you're looking for doesn't exist.",
                          back_link=url_for('home')), 404


@app.errorhandler(500)
def internal_error(error):
    """Handle 500 errors with user-friendly message."""
    # Log the actual error for debugging
    app.logger.error(f'Internal error: {error}')

    # Close any open database connections
    db = g.pop('db', None)
    if db is not None:
        try:
            db.close()
        except:
            pass

    return render_template('error.html',
                          error_message="Something went wrong on our end. Please try again.",
                          back_link=url_for('home')), 500


@app.errorhandler(Exception)
def handle_exception(error):
    """Catch-all handler for unexpected exceptions."""
    # Log the actual error for debugging
    app.logger.error(f'Unhandled exception: {error}', exc_info=True)

    # Close any open database connections
    db = g.pop('db', None)
    if db is not None:
        try:
            db.close()
        except:
            pass

    # Return 500 error page
    return render_template('error.html',
                          error_message="An unexpected error occurred. Please try again.",
                          back_link=url_for('home')), 500


# ============================================================================
# ROUTES
# ============================================================================

@app.route('/')
def home():
    """Home page - level selection."""
    return render_template('level_select.html')


@app.route('/category/<level>')
def category_menu(level):
    """Category menu for a specific level."""
    return render_template('category_menu.html', level=level)


@app.route('/verbs/<level>')
def verbs_menu(level):
    """Verbs submenu for a specific level."""
    return render_template('verbs_menu.html', level=level)


@app.route('/vocabulary/<level>')
def vocabulary_menu(level):
    """Vocabulary submenu for a specific level."""
    return render_template('vocabulary_menu.html', level=level)


@app.route('/grammar/<level>')
def grammar_menu(level):
    """Grammar submenu for a specific level."""
    return render_template('grammar_menu.html', level=level)


@app.route('/mixed/<level>')
def mixed_menu(level):
    """Mixed practice submenu for a specific level."""
    return render_template('mixed_menu.html', level=level)


@app.route('/reading/<level>')
def reading_menu(level):
    """Reading comprehension menu for a specific level."""
    return render_template('reading_menu.html', level=level)


@app.route('/reading-comprehension', methods=['GET', 'POST'])
def reading_comprehension():
    """Reading comprehension practice with Italian stories."""
    level = validate_level(request.args.get('level') or request.form.get('level') or session.get('level', 'A2'))

    if request.method == 'GET':
        session['level'] = level
        # Generate a new story for this level
        story = generate_story_for_level(level)
        questions = generate_comprehension_questions(story, level)

        # Store in session
        session['reading_story'] = story
        session['reading_questions'] = questions
        session['reading_current'] = 0
        session['reading_correct'] = 0
        session['reading_answers'] = []

        return render_template('reading_story.html', story=story, level=level)

    # POST: Submit answer to comprehension question
    answer = request.form.get('answer', '').strip()
    current_idx = session.get('reading_current', 0)
    questions = session.get('reading_questions', [])

    if current_idx < len(questions):
        question = questions[current_idx]
        is_correct = answer.lower() == question['correct'].lower()

        if is_correct:
            session['reading_correct'] = session.get('reading_correct', 0) + 1

        # Store answer
        answers = session.get('reading_answers', [])
        answers.append({
            'question': question['question'],
            'user_answer': answer,
            'correct_answer': question['correct'],
            'is_correct': is_correct
        })
        session['reading_answers'] = answers
        session['reading_current'] = current_idx + 1

    # Check if quiz is complete
    if session.get('reading_current', 0) >= len(questions):
        return redirect(url_for('reading_summary'))

    return redirect(url_for('reading_question'))


@app.route('/reading/question')
def reading_question():
    """Show current reading comprehension question."""
    if 'reading_questions' not in session:
        return redirect(url_for('home'))

    current_idx = session.get('reading_current', 0)
    questions = session.get('reading_questions', [])
    story = session.get('reading_story', {})
    level = session.get('level', 'A2')

    if current_idx >= len(questions):
        return redirect(url_for('reading_summary'))

    question = questions[current_idx]

    # Get the appropriate menu for the back button
    menu_route = 'reading_menu'

    return render_template('reading_question.html',
                          story=story,
                          question=question,
                          question_num=current_idx + 1,
                          total_questions=len(questions),
                          menu_route=menu_route,
                          level=level)


@app.route('/reading/summary')
def reading_summary():
    """Show reading comprehension summary."""
    if 'reading_questions' not in session:
        return redirect(url_for('home'))

    questions = session.get('reading_questions', [])
    correct_count = session.get('reading_correct', 0)
    answers = session.get('reading_answers', [])
    level = session.get('level', 'A2')

    total_questions = len(questions)
    accuracy = (correct_count / total_questions * 100) if total_questions > 0 else 0

    # Clear session
    session.pop('reading_story', None)
    session.pop('reading_questions', None)
    session.pop('reading_current', None)
    session.pop('reading_correct', None)
    session.pop('reading_answers', None)

    return render_template('reading_summary.html',
                          correct_count=correct_count,
                          total_questions=total_questions,
                          accuracy=accuracy,
                          answers=answers,
                          level=level)


def _load_stories_for_level(level: str) -> list:
    """Load stories JSON for the given level, with fallback to legacy hardcoded story."""
    level_map = {'A1': 'a1', 'A2': 'a2', 'B1': 'b1', 'B2': 'b2', 'GCSE': 'gcse'}
    key = level_map.get(level, 'a2')
    stories_dir = Path(__file__).parent / 'data' / 'reading_stories'
    json_path = stories_dir / f'{key}_stories.json'
    if json_path.exists():
        try:
            with open(json_path, encoding='utf-8') as f:
                return json.load(f)
        except Exception:
            pass
    return []


def generate_story_for_level(level: str) -> dict:
    """Pick a random story appropriate for the given CEFR level from JSON files."""
    stories = _load_stories_for_level(level)
    if stories:
        story = random.choice(stories)
        # Normalise vocab_hints to a string for template compatibility
        vh = story.get('vocab_hints', '')
        if isinstance(vh, dict):
            story['vocab_hints'] = ', '.join(f'{k} = {v}' for k, v in vh.items())
        return story
    # Fallback: minimal inline story if JSON missing
    return {
        'id': f'{level.lower()}_fallback',
        'title': 'Una Giornata Italiana',
        'text': 'Marco abita a Roma. Ogni mattina va al bar e prende un caffÃ¨. Poi va al lavoro. La sera mangia con la famiglia.',
        'vocab_hints': 'abita = lives, prende = takes/has, mangia = eats',
        'questions': []
    }


def generate_comprehension_questions(story: dict, level: str) -> list:
    """Return comprehension questions from the story dict (already embedded in JSON)."""
    raw_questions = story.get('questions', [])
    normalised = []
    for q in raw_questions:
        correct_raw = q.get('correct')
        choices = q.get('choices', [])
        # Normalise: if correct is an int index, convert to the choice text
        if isinstance(correct_raw, int):
            correct_text = choices[correct_raw] if 0 <= correct_raw < len(choices) else ''
        else:
            correct_text = str(correct_raw)
        normalised.append({
            'question': q.get('question', ''),
            'choices': choices,
            'correct': correct_text
        })
    return normalised


@app.route('/vocabulary-quiz', methods=['GET', 'POST'])
def vocabulary_quiz():
    """Vocabulary quiz practice."""
    # Get level from query params (from menu) or form (from setup)
    level = request.args.get('level') or request.form.get('level', 'A2')

    if request.method == 'GET':
        # Always show setup form; pre-select direction if passed in URL
        direction_hint = request.args.get('direction', 'it_to_en')
        return render_template('vocabulary_quiz_setup.html', level=level, direction_hint=direction_hint)

    # POST: get direction and count from form
    direction = request.form.get('direction', 'it_to_en')
    count = validate_count(request.form.get('count', 10))

    # Generate questions using fresh generator
    generator = get_generator()
    questions = generator.generate_vocabulary_quiz(level, count, direction)

    # Store in session
    session['practice_type'] = 'vocabulary_quiz'
    session['questions'] = questions
    session['current_question'] = 0
    session['correct_count'] = 0
    session['answers'] = []
    session['start_time'] = time.time()
    session['level'] = level
    session['direction'] = direction
    srs_mode = request.form.get('srs_mode') == '1'
    session['srs_mode'] = srs_mode
    session['srs_original_count'] = len(questions)
    session['srs_wrong_queue'] = []
    session['srs_injected'] = False

    return redirect(url_for('practice_question'))


@app.route('/practice/question')
def practice_question():
    """Show current question."""
    try:
        if 'questions' not in session or 'current_question' not in session:
            return redirect(url_for('home'))

        questions = session.get('questions', [])
        current_idx = session.get('current_question', 0)

        # Check if quiz is complete
        if current_idx >= len(questions):
            return redirect(url_for('practice_summary'))

        if not questions:
            return render_template('error.html',
                                  error_message="No questions available. Please start a new practice session.",
                                  back_link=url_for('home'))

        question = questions[current_idx]
        total_questions = len(questions)

        # Get the appropriate menu for the back button
        practice_type = session.get('practice_type', '')
        menu_route = get_menu_for_practice_type(practice_type)
        level = session.get('level', 'A2')

        # Word-order questions use a custom tile template
        if question.get('type') == 'word_order':
            return render_template('word_order_question.html',
                                  question=question,
                                  question_num=current_idx + 1,
                                  total_questions=total_questions,
                                  menu_route=menu_route,
                                  level=level)

        return render_template('question.html',
                              question=question,
                              question_num=current_idx + 1,
                              total_questions=total_questions,
                              menu_route=menu_route,
                              level=level)
    except (KeyError, IndexError, TypeError) as e:
        app.logger.error(f'Error in practice_question: {e}')
        return render_template('error.html',
                              error_message="Session error. Please start a new practice session.",
                              back_link=url_for('home'))


@app.route('/practice/submit', methods=['POST'])
def submit_answer():
    """Process submitted answer."""
    try:
        if 'questions' not in session:
            return redirect(url_for('home'))

        user_answer = request.form.get('answer', '').strip()
        questions = session.get('questions', [])
        current_idx = session.get('current_question', 0)

        if not questions or current_idx >= len(questions):
            return render_template('error.html',
                                  error_message="Session expired. Please start a new practice session.",
                                  back_link=url_for('home'))

        question = questions[current_idx]
    except (KeyError, IndexError, TypeError) as e:
        app.logger.error(f'Error in submit_answer: {e}')
        return render_template('error.html',
                              error_message="Session error. Please start a new practice session.",
                              back_link=url_for('home'))

    # Check answer with flexible matching, passing question type for special handling
    question_type = question.get('type', None)
    is_correct, display_answer = check_answer(user_answer, question['answer'], question_type)

    # Track answer
    if is_correct:
        session['correct_count'] = session.get('correct_count', 0) + 1

    # Store result
    answers = session.get('answers', [])
    answers.append({
        'question': question['question'],
        'user_answer': user_answer,
        'correct_answer': display_answer,
        'is_correct': is_correct
    })
    session['answers'] = answers

    # SRS: queue wrong questions for re-attempt at end of session
    if session.get('srs_mode') and not is_correct and not session.get('srs_injected'):
        srs_queue = session.get('srs_wrong_queue', [])
        srs_queue.append(dict(question))
        session['srs_wrong_queue'] = srs_queue

    # Show feedback (with explanation if available)
    explanation = question.get('explanation', None) or question.get('reason', None)
    hint = question.get('hint', None)

    # Add etymology / fun fact â€” shown on all question types
    # Try the Italian word in the question first, then fall back to a general fact
    italian_word = (question.get('italian')
                    or question.get('infinitive')
                    or display_answer)
    etymology = get_etymology_fact(italian_word)

    # Get the appropriate menu for the back button
    practice_type = session.get('practice_type', '')
    menu_route = get_menu_for_practice_type(practice_type)
    level = session.get('level', 'A2')

    return render_template('feedback.html',
                          is_correct=is_correct,
                          user_answer=user_answer,
                          correct_answer=display_answer,
                          question_type=question_type,
                          explanation=explanation,
                          hint=hint,
                          etymology=etymology,
                          question_num=current_idx + 1,
                          total_questions=len(questions),
                          menu_route=menu_route,
                          level=level)


@app.route('/practice/next')
def next_question():
    """Move to next question, injecting SRS re-attempts if applicable."""
    if 'questions' not in session:
        return redirect(url_for('home'))

    next_idx = session.get('current_question', 0) + 1

    # SRS: once we've reached the end of the original questions, inject wrong ones
    if (session.get('srs_mode') and
            not session.get('srs_injected') and
            next_idx >= session.get('srs_original_count', 999)):
        wrong_queue = session.get('srs_wrong_queue', [])
        if wrong_queue:
            questions = session.get('questions', [])
            # Add a review hint to each re-attempt question
            for q in wrong_queue:
                retry_q = dict(q)
                retry_q['hint'] = f"ğŸ” Review: {retry_q.get('hint', 'try again!')}"
                questions.append(retry_q)
            session['questions'] = questions
            session['srs_wrong_queue'] = []
            session['srs_injected'] = True

    session['current_question'] = next_idx
    return redirect(url_for('practice_question'))


@app.route('/practice/skip')
def skip_question():
    """Skip the current question â€” marks as incorrect, no feedback page."""
    if 'questions' not in session:
        return redirect(url_for('home'))

    questions = session.get('questions', [])
    current_idx = session.get('current_question', 0)

    if 0 <= current_idx < len(questions):
        question = questions[current_idx]
        answers = session.get('answers', [])
        answers.append({
            'question': question['question'],
            'user_answer': '[skipped]',
            'correct_answer': question.get('answer', ''),
            'is_correct': False
        })
        session['answers'] = answers

    # Advance without showing feedback
    next_idx = current_idx + 1

    # SRS: if skipped, also add to wrong queue for review
    if session.get('srs_mode') and not session.get('srs_injected') and 0 <= current_idx < len(questions):
        srs_queue = session.get('srs_wrong_queue', [])
        srs_queue.append(dict(questions[current_idx]))
        session['srs_wrong_queue'] = srs_queue

    # SRS injection check (same as next_question)
    if (session.get('srs_mode') and
            not session.get('srs_injected') and
            next_idx >= session.get('srs_original_count', 999)):
        wrong_queue = session.get('srs_wrong_queue', [])
        if wrong_queue:
            for q in wrong_queue:
                retry_q = dict(q)
                retry_q['hint'] = f"ğŸ” Review: {retry_q.get('hint', 'try again!')}"
                questions.append(retry_q)
            session['questions'] = questions
            session['srs_wrong_queue'] = []
            session['srs_injected'] = True

    session['current_question'] = next_idx
    return redirect(url_for('practice_question'))


@app.route('/practice/flag', methods=['POST'])
def flag_question():
    """Flag the current question as a possible error, send a report email,
    keep it in the session's flagged list, then advance to the next question."""
    if 'questions' not in session:
        return redirect(url_for('home'))

    questions   = session.get('questions', [])
    current_idx = session.get('current_question', 0)

    if 0 <= current_idx < len(questions):
        question     = questions[current_idx]
        user_answer  = request.form.get('user_answer', '')
        practice_type = session.get('practice_type', 'unknown')
        level         = session.get('level', 'A2')
        hint          = question.get('hint', '') or question.get('tense', '')
        explanation   = question.get('explanation', '') or question.get('reason', '')

        # Send (or log) the mini error report
        email_sent = send_error_report(
            question_text  = question.get('question', ''),
            correct_answer = question.get('answer', ''),
            user_answer    = user_answer,
            practice_type  = practice_type,
            level          = level,
            hint           = hint,
            explanation    = explanation,
        )

        # Keep a record in the session so it appears in the summary too
        flagged = session.get('flagged_questions', [])
        flagged.append({
            'question': question.get('question', ''),
            'answer':   question.get('answer', ''),
        })
        session['flagged_questions'] = flagged

        # Flash a confirmation so the user knows the report went through
        if email_sent:
            flash('ğŸš© Error reported â€” thanks! We\'ll look into it.', 'flag')
        else:
            flash('ğŸš© Error noted â€” flagged for review.', 'flag')

    return redirect(url_for('next_question'))


# â”€â”€ New activities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.route('/mixed-tense', methods=['GET', 'POST'])
def mixed_tense_drill():
    """Interleaved tense drill â€” multiple tenses shuffled together."""
    level = validate_level(request.args.get('level') or request.form.get('level') or session.get('level', 'A2'))

    if request.method == 'GET':
        session['level'] = level
        return render_template('mixed_tense_setup.html', level=level)

    count = validate_count(request.form.get('count', 10))
    generator = get_generator()
    questions = generator.generate_mixed_tense_drill(level, count)

    if not questions:
        return render_template('error.html',
                             error_message=f"No mixed tense exercises available for {level}. Please try a different level.",
                             back_link=url_for('verbs_menu', level=level))

    session['practice_type'] = 'mixed_tense'
    session['questions'] = questions
    session['current_question'] = 0
    session['correct_count'] = 0
    session['answers'] = []
    session['start_time'] = time.time()
    session['level'] = level
    srs_mode = request.form.get('srs_mode') == '1'
    session['srs_mode'] = srs_mode
    session['srs_original_count'] = len(questions)
    session['srs_wrong_queue'] = []
    session['srs_injected'] = False

    return redirect(url_for('practice_question'))


@app.route('/word-order', methods=['GET', 'POST'])
def word_order():
    """Word-order tile activity â€” assemble an Italian sentence from shuffled chips."""
    level = validate_level(request.args.get('level') or request.form.get('level') or session.get('level', 'A2'))

    if request.method == 'GET':
        session['level'] = level
        return render_template('word_order_setup.html', level=level)

    count = validate_count(request.form.get('count', 10))
    generator = get_generator()
    questions = generator.generate_word_order(level, count)

    if not questions:
        return render_template('error.html',
                             error_message=f"No word-order exercises available for {level}. Please try a different level.",
                             back_link=url_for('mixed_menu', level=level))

    session['practice_type'] = 'word_order'
    session['questions'] = questions
    session['current_question'] = 0
    session['correct_count'] = 0
    session['answers'] = []
    session['start_time'] = time.time()
    session['level'] = level
    session['srs_mode'] = False
    session['srs_original_count'] = len(questions)
    session['srs_wrong_queue'] = []
    session['srs_injected'] = False

    return redirect(url_for('practice_question'))


@app.route('/tense-discrimination', methods=['GET', 'POST'])
def tense_discrimination():
    """Passato Prossimo vs Imperfetto discrimination drill."""
    level = validate_level(request.args.get('level') or request.form.get('level') or session.get('level', 'A2'))

    if request.method == 'GET':
        session['level'] = level
        return render_template('tense_discrimination_setup.html', level=level)

    count = validate_count(request.form.get('count', 10))
    generator = get_generator()
    questions = generator.generate_tense_discrimination(level, count)

    if not questions:
        return render_template('error.html',
                             error_message=f"No tense discrimination exercises available for {level}.",
                             back_link=url_for('verbs_menu', level=level))

    session['practice_type'] = 'tense_discrimination'
    session['questions'] = questions
    session['current_question'] = 0
    session['correct_count'] = 0
    session['answers'] = []
    session['start_time'] = time.time()
    session['level'] = level
    srs_mode = request.form.get('srs_mode') == '1'
    session['srs_mode'] = srs_mode
    session['srs_original_count'] = len(questions)
    session['srs_wrong_queue'] = []
    session['srs_injected'] = False

    return redirect(url_for('practice_question'))


@app.route('/error-correction', methods=['GET', 'POST'])
def error_correction():
    """Error correction drill â€” identify and fix grammatical errors."""
    level = validate_level(request.args.get('level') or request.form.get('level') or session.get('level', 'A2'))

    if request.method == 'GET':
        session['level'] = level
        return render_template('error_correction_setup.html', level=level)

    count = validate_count(request.form.get('count', 10))
    generator = get_generator()
    questions = generator.generate_error_correction(level, count)

    if not questions:
        return render_template('error.html',
                             error_message=f"No error correction exercises available for {level}.",
                             back_link=url_for('mixed_menu', level=level))

    session['practice_type'] = 'error_correction'
    session['questions'] = questions
    session['current_question'] = 0
    session['correct_count'] = 0
    session['answers'] = []
    session['start_time'] = time.time()
    session['level'] = level
    srs_mode = request.form.get('srs_mode') == '1'
    session['srs_mode'] = srs_mode
    session['srs_original_count'] = len(questions)
    session['srs_wrong_queue'] = []
    session['srs_injected'] = False

    return redirect(url_for('practice_question'))


@app.route('/practice/summary')
def practice_summary():
    """Show practice session summary."""
    if 'questions' not in session:
        return redirect(url_for('home'))

    questions = session['questions']
    correct_count = session.get('correct_count', 0)
    total_questions = len(questions)

    # Calculate stats
    elapsed_time = int(time.time() - session.get('start_time', time.time()))
    accuracy = (correct_count / total_questions * 100) if total_questions > 0 else 0

    # Determine grade
    if accuracy >= 90:
        grade = "Excellent!"
        grade_emoji = "ğŸŒŸ"
    elif accuracy >= 75:
        grade = "Good job!"
        grade_emoji = "ğŸ‘"
    elif accuracy >= 60:
        grade = "Keep practicing!"
        grade_emoji = "ğŸ“š"
    else:
        grade = "More practice needed!"
        grade_emoji = "ğŸ’ª"

    # Save to database using fresh connection
    practice_type = session.get('practice_type', 'vocabulary_quiz')
    db = get_db()
    session_id = db.record_practice_session(
        session_type=practice_type,
        total_questions=total_questions,
        correct_answers=correct_count,
        time_spent=elapsed_time
    )
    db.close()

    # Format time
    minutes = elapsed_time // 60
    seconds = elapsed_time % 60
    time_str = f"{minutes}m {seconds}s"

    summary = {
        'correct': correct_count,
        'total': total_questions,
        'accuracy': accuracy,
        'time': time_str,
        'grade': grade,
        'grade_emoji': grade_emoji,
        'session_id': session_id,
        'answers': session.get('answers', [])
    }

    # Get level and practice type before clearing session
    level = session.get('level', 'A2')
    practice_type = session.get('practice_type', 'vocabulary_quiz')
    direction = session.get('direction', None)  # For vocabulary quiz
    flagged_questions = session.get('flagged_questions', [])

    # Build practice_again_url using PRACTICE_ROUTES mapping
    practice_again_url = url_for('category_menu', level=level)  # Default fallback
    if practice_type in PRACTICE_ROUTES:
        route_name, required_params = PRACTICE_ROUTES[practice_type]
        params = {'level': level}
        if 'direction' in required_params and direction:
            params['direction'] = direction
        practice_again_url = url_for(route_name, **params)

    # Clear session
    for key in ['questions', 'current_question', 'correct_count', 'answers',
                'start_time', 'practice_type', 'direction',
                'srs_mode', 'srs_original_count', 'srs_wrong_queue', 'srs_injected',
                'flagged_questions']:
        session.pop(key, None)

    return render_template('summary.html',
                          summary=summary,
                          level=level,
                          practice_type=practice_type,
                          direction=direction,
                          practice_again_url=practice_again_url,
                          flagged_questions=flagged_questions)


@app.route('/verb-conjugation', methods=['GET', 'POST'])
def verb_conjugation():
    """General verb conjugation practice."""
    return create_practice_route(
        practice_type='verb_conjugation',
        generator_method='generate_verb_conjugation_drill',
        setup_template='verb_conjugation_setup.html',
        menu_type='verbs_menu',
        requires_level=True
    )()


@app.route('/irregular-passato', methods=['GET', 'POST'])
def irregular_passato():
    """Irregular passato prossimo practice."""
    return create_practice_route(
        practice_type='irregular_passato',
        generator_method='generate_irregular_passato_prossimo',
        setup_template='irregular_passato_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/regular-passato', methods=['GET', 'POST'])
def regular_passato():
    """Regular passato prossimo practice."""
    return create_practice_route(
        practice_type='regular_passato',
        generator_method='generate_regular_passato_prossimo',
        setup_template='regular_passato_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/imperfect-tense', methods=['GET', 'POST'])
def imperfect_tense():
    """Imperfect tense (imperfetto) practice."""
    return create_practice_route(
        practice_type='imperfect_tense',
        generator_method='generate_imperfect_tense',
        setup_template='imperfect_tense_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/auxiliary-choice', methods=['GET', 'POST'])
def auxiliary_choice():
    """Avere vs Essere auxiliary choice practice."""
    return create_practice_route(
        practice_type='auxiliary_choice',
        generator_method='generate_auxiliary_choice',
        setup_template='auxiliary_choice_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/futuro-semplice', methods=['GET', 'POST'])
def futuro_semplice():
    """Futuro semplice practice."""
    return create_practice_route(
        practice_type='futuro_semplice',
        generator_method='generate_futuro_semplice',
        setup_template='futuro_semplice_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/reflexive-verbs', methods=['GET', 'POST'])
def reflexive_verbs():
    """Reflexive verbs practice."""
    return create_practice_route(
        practice_type='reflexive_verbs',
        generator_method='generate_reflexive_verbs',
        setup_template='reflexive_verbs_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/reflexive-passato-prossimo', methods=['GET', 'POST'])
def reflexive_passato_prossimo():
    """Reflexive verbs in passato prossimo practice (A2)."""
    return create_practice_route(
        practice_type='reflexive_passato_prossimo',
        generator_method='generate_reflexive_passato_prossimo',
        setup_template='reflexive_passato_prossimo_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/conditional-present', methods=['GET', 'POST'])
def conditional_present():
    """Conditional present tense practice."""
    return create_practice_route(
        practice_type='conditional_present',
        generator_method='generate_conditional_present',
        setup_template='conditional_present_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/imperative', methods=['GET', 'POST'])
def imperative():
    """Imperative (command) tense practice."""
    return create_practice_route(
        practice_type='imperative',
        generator_method='generate_imperative_practice',
        setup_template='imperative_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/progressive-gerund', methods=['GET', 'POST'])
def progressive_gerund():
    """Progressive forms and gerund practice (B1 level)."""
    return create_practice_route(
        practice_type='progressive_gerund',
        generator_method='generate_progressive_gerund',
        setup_template='progressive_gerund_setup.html',
        menu_type='grammar_menu',
        requires_level=False
    )()


@app.route('/causative', methods=['GET', 'POST'])
def causative():
    """Causative constructions with fare/lasciare (B1 level)."""
    return create_practice_route(
        practice_type='causative',
        generator_method='generate_causative_constructions',
        setup_template='causative_setup.html',
        menu_type='grammar_menu',
        requires_level=False
    )()


@app.route('/advanced-pronouns', methods=['GET', 'POST'])
def advanced_pronouns():
    """Advanced pronouns ci and ne practice (B1 level)."""
    return create_practice_route(
        practice_type='advanced_pronouns',
        generator_method='generate_advanced_pronouns_ci_ne',
        setup_template='advanced_pronouns_setup.html',
        menu_type='grammar_menu',
        requires_level=False
    )()


@app.route('/conditional-past', methods=['GET', 'POST'])
def conditional_past():
    """Conditional past (condizionale passato) practice (B1 level)."""
    return create_practice_route(
        practice_type='conditional_past',
        generator_method='generate_conditional_past',
        setup_template='conditional_past_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/past-perfect', methods=['GET', 'POST'])
def past_perfect():
    """Past perfect (trapassato prossimo) practice (B1 level)."""
    return create_practice_route(
        practice_type='past_perfect',
        generator_method='generate_past_perfect',
        setup_template='past_perfect_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/passive-voice', methods=['GET', 'POST'])
def passive_voice():
    """Passive voice (forma passiva) practice (B1 level)."""
    return create_practice_route(
        practice_type='passive_voice',
        generator_method='generate_passive_voice',
        setup_template='passive_voice_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/pronominal-verbs', methods=['GET', 'POST'])
def pronominal_verbs():
    """Pronominal verbs practice (A2 level)."""
    return create_practice_route(
        practice_type='pronominal_verbs',
        generator_method='generate_pronominal_verbs',
        setup_template='pronominal_verbs_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/subjunctive-present', methods=['GET', 'POST'])
def subjunctive_present():
    """Subjunctive present (congiuntivo presente) practice (A2 level)."""
    return create_practice_route(
        practice_type='subjunctive_present',
        generator_method='generate_subjunctive_present',
        setup_template='subjunctive_present_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/subjunctive-past', methods=['GET', 'POST'])
def subjunctive_past():
    """Subjunctive past (congiuntivo passato) practice (B1 level)."""
    return create_practice_route(
        practice_type='subjunctive_past',
        generator_method='generate_subjunctive_past',
        setup_template='subjunctive_past_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/subjunctive-imperfect', methods=['GET', 'POST'])
def subjunctive_imperfect():
    """Subjunctive imperfect (congiuntivo imperfetto) practice (B1 level)."""
    return create_practice_route(
        practice_type='subjunctive_imperfect',
        generator_method='generate_subjunctive_imperfect',
        setup_template='subjunctive_imperfect_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/subjunctive-past-perfect', methods=['GET', 'POST'])
def subjunctive_past_perfect():
    """Subjunctive past perfect (congiuntivo trapassato) practice (B1 level)."""
    return create_practice_route(
        practice_type='subjunctive_past_perfect',
        generator_method='generate_subjunctive_past_perfect',
        setup_template='subjunctive_past_perfect_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/passato-remoto', methods=['GET', 'POST'])
def passato_remoto():
    """Passato remoto practice (B2 level)."""
    return create_practice_route(
        practice_type='passato_remoto',
        generator_method='generate_passato_remoto',
        setup_template='passato_remoto_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/relative-pronouns', methods=['GET', 'POST'])
def relative_pronouns():
    """Relative pronouns practice (B2 level)."""
    return create_practice_route(
        practice_type='relative_pronouns',
        generator_method='generate_relative_pronouns',
        setup_template='relative_pronouns_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/impersonal-si', methods=['GET', 'POST'])
def impersonal_si():
    """Impersonal si practice (B2 level)."""
    return create_practice_route(
        practice_type='impersonal_si',
        generator_method='generate_impersonal_si',
        setup_template='impersonal_si_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/unreal-past', methods=['GET', 'POST'])
def unreal_past():
    """Unreal past conditionals (B2 level)."""
    return create_practice_route(
        practice_type='unreal_past',
        generator_method='generate_unreal_past',
        setup_template='unreal_past_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/unreal-present', methods=['GET', 'POST'])
def unreal_present():
    """Unreal present conditionals (B1 level) - Se + imperfect subjunctive + conditional."""
    return create_practice_route(
        practice_type='unreal_present',
        generator_method='generate_unreal_present',
        setup_template='unreal_present_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/comprehensive-subjunctives', methods=['GET', 'POST'])
def comprehensive_subjunctives():
    """Comprehensive subjunctives review (B2 level)."""
    return create_practice_route(
        practice_type='comprehensive_subjunctives',
        generator_method='generate_comprehensive_subjunctives',
        setup_template='comprehensive_subjunctives_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/present-tense', methods=['GET', 'POST'])
def present_tense():
    """Present tense conjugation practice (A1 level)."""
    level = request.args.get('level') or request.form.get('level') or session.get('level', 'A1')

    if request.method == 'GET':
        session['level'] = level
        return render_template('present_tense_setup.html', level=level)

    count = validate_count(request.form.get('count', 10))
    generator = get_generator()
    questions = generator.generate_present_tense_conjugation(count)

    session['practice_type'] = 'present_tense'
    session['questions'] = questions
    session['current_question'] = 0
    session['correct_count'] = 0
    session['answers'] = []
    session['start_time'] = time.time()
    session['level'] = level  # Store level for navigation

    return redirect(url_for('practice_question'))


# Bug-0088: Focused present-tense conjugation drills by verb ending type

@app.route('/are-verb-present', methods=['GET', 'POST'])
def are_verb_present():
    """Regular -ARE verb present tense conjugation practice (A1 level)."""
    return create_practice_route(
        practice_type='are_verb_present',
        generator_method='generate_are_verb_present',
        setup_template='are_verb_present_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/ere-verb-present', methods=['GET', 'POST'])
def ere_verb_present():
    """Regular -ERE verb present tense conjugation practice (A2 level)."""
    return create_practice_route(
        practice_type='ere_verb_present',
        generator_method='generate_ere_verb_present',
        setup_template='ere_verb_present_setup.html',
        menu_type='verbs_menu'
    )()


@app.route('/ire-verb-present', methods=['GET', 'POST'])
def ire_verb_present():
    """Regular -IRE verb present tense conjugation practice (A2 level)."""
    return create_practice_route(
        practice_type='ire_verb_present',
        generator_method='generate_ire_verb_present',
        setup_template='ire_verb_present_setup.html',
        menu_type='verbs_menu'
    )()


# Bug-0094: New A1 Italian articles activity

@app.route('/italian-articles', methods=['GET', 'POST'])
def italian_articles():
    """Italian articles practice (A1 level) â€” definite, indefinite, gender and vowel rules."""
    return create_practice_route(
        practice_type='italian_articles',
        generator_method='generate_italian_articles',
        setup_template='italian_articles_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/noun-gender-number', methods=['GET', 'POST'])
def noun_gender_number():
    """Noun gender and number identification practice."""
    return create_practice_route(
        practice_type='noun_gender_number',
        generator_method='generate_noun_gender_number',
        setup_template='noun_gender_number_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/articulated-prepositions', methods=['GET', 'POST'])
def articulated_prepositions():
    """Articulated prepositions practice."""
    return create_practice_route(
        practice_type='articulated_prepositions',
        generator_method='generate_articulated_prepositions',
        setup_template='articulated_prepositions_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/time-prepositions', methods=['GET', 'POST'])
def time_prepositions():
    """Time prepositions practice."""
    return create_practice_route(
        practice_type='time_prepositions',
        generator_method='generate_time_prepositions',
        setup_template='time_prepositions_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/verb-prepositions', methods=['GET', 'POST'])
def verb_prepositions():
    """Verbs with fixed prepositions practice (verbi con preposizione)."""
    return create_practice_route(
        practice_type='verb_prepositions',
        generator_method='generate_verb_prepositions',
        setup_template='verb_prepositions_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/negations', methods=['GET', 'POST'])
def negations():
    """Negations practice."""
    return create_practice_route(
        practice_type='negations',
        generator_method='generate_negation_practice',
        setup_template='negations_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/pronouns', methods=['GET', 'POST'])
def pronouns():
    """Direct and indirect pronouns practice."""
    return create_practice_route(
        practice_type='pronouns',
        generator_method='generate_pronouns_practice',
        setup_template='pronouns_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/combined-pronouns', methods=['GET', 'POST'])
def combined_pronouns():
    """Combined pronouns practice (B1 level)."""
    return create_practice_route(
        practice_type='combined_pronouns',
        generator_method='generate_combined_pronouns',
        setup_template='combined_pronouns_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/adverbs', methods=['GET', 'POST'])
def adverbs():
    """Adverbs practice."""
    return create_practice_route(
        practice_type='adverbs',
        generator_method='generate_adverbs_practice',
        setup_template='adverbs_setup.html',
        menu_type='grammar_menu'
    )()


@app.route('/fill-in-blank', methods=['GET', 'POST'])
def fill_in_blank():
    """Fill in the blank practice."""
    level = validate_level(request.args.get('level') or request.form.get('level') or session.get('level', 'A2'))

    if request.method == 'GET':
        session['level'] = level
        return render_template('fill_in_blank_setup.html', level=level)

    count = validate_count(request.form.get('count', 10))
    generator = get_generator()
    questions = generator.generate_fill_in_blank(level, count)

    session['practice_type'] = 'fill_in_blank'
    session['questions'] = questions
    session['current_question'] = 0
    session['correct_count'] = 0
    session['answers'] = []
    session['start_time'] = time.time()
    session['level'] = level  # Store level for navigation

    return redirect(url_for('practice_question'))


@app.route('/multiple-choice', methods=['GET', 'POST'])
def multiple_choice():
    """Multiple choice practice."""
    level = validate_level(request.args.get('level') or request.form.get('level') or session.get('level', 'A2'))

    if request.method == 'GET':
        session['level'] = level
        return render_template('multiple_choice_setup.html', level=level)

    count = validate_count(request.form.get('count', 10))
    generator = get_generator()
    questions = generator.generate_multiple_choice(level, count)

    session['practice_type'] = 'multiple_choice'
    session['questions'] = questions
    session['current_question'] = 0
    session['correct_count'] = 0
    session['answers'] = []
    session['start_time'] = time.time()
    session['level'] = level  # Store level for navigation

    return redirect(url_for('practice_question'))


@app.route('/sentence-translator', methods=['GET', 'POST'])
def sentence_translator():
    """Sentence translation practice."""
    level = validate_level(request.args.get('level') or request.form.get('level') or session.get('level', 'A2'))

    if request.method == 'GET':
        direction = request.args.get('direction', 'it_to_en')
        session['level'] = level
        return render_template('sentence_translator_setup.html', level=level, direction=direction)

    direction = request.form.get('direction', 'it_to_en')
    count = validate_count(request.form.get('count', 10))

    generator = get_generator()
    questions = generator.generate_sentence_translation(level, count, direction)

    # Check if questions were generated
    if not questions or len(questions) == 0:
        session['level'] = level
        return render_template('error.html',
                             error_message=f"No sentence translation exercises available for {level}. Please try a different level.",
                             back_link=url_for('vocabulary_menu', level=level))

    session['practice_type'] = 'sentence_translator'
    session['questions'] = questions
    session['current_question'] = 0
    session['correct_count'] = 0
    session['answers'] = []
    session['start_time'] = time.time()
    session['level'] = level  # Store level for navigation

    return redirect(url_for('practice_question'))


@app.route('/stats')
def view_stats():
    """View progress statistics."""
    # Get fresh database connection
    db = get_db()

    # Get stats for different periods
    stats_7 = db.get_performance_stats(7)
    stats_30 = db.get_performance_stats(30)
    stats_90 = db.get_performance_stats(90)

    # Get weak areas
    weak_areas = db.get_weak_areas(5)

    db.close()

    return render_template('stats.html',
                          stats_7=stats_7,
                          stats_30=stats_30,
                          stats_90=stats_90,
                          weak_areas=weak_areas)


@app.route('/topics')
def view_topics():
    """View all topics by level."""
    # Get fresh database connection
    db = get_db()

    topics_a1 = db.get_topics_by_level("A1")
    topics_a2 = db.get_topics_by_level("A2")

    db.close()

    return render_template('topics.html',
                          topics_a1=topics_a1,
                          topics_a2=topics_a2)


if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5001)
