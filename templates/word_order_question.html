{% extends "base.html" %}

{% block title %}Question {{ question_num }} of {{ total_questions }}{% endblock %}

{% block content %}
<div class="question-card">
    <div class="question-header">
        Question {{ question_num }} of {{ total_questions }}
    </div>

    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ (question_num / total_questions * 100) }}%"></div>
    </div>

    <div class="question-text" style="font-size: 1.1rem;">
        {{ question.question }}
    </div>

    <!-- Answer area: selected words appear here -->
    <div id="answer-area"
         style="min-height: 54px; background: #f8faff; border: 2px dashed #aed6f1; border-radius: 8px;
                padding: 10px 12px; margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 8px;
                align-items: center; cursor: pointer;"
         onclick="return false;">
        <span id="answer-placeholder" style="color: #aaa; font-size: 0.9rem; user-select: none;">
            Tap words below to build your sentence‚Ä¶
        </span>
    </div>

    <!-- Word bank: shuffled chips -->
    <div id="word-bank"
         style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
        {% for word in question.words %}
        <button type="button"
                class="word-chip"
                data-word="{{ word }}"
                onclick="selectWord(this)"
                style="padding: 10px 16px; background: white; border: 2px solid #3498db;
                       border-radius: 20px; cursor: pointer; font-size: 1rem; color: #2471a3;
                       transition: all 0.2s;">
            {{ word }}
        </button>
        {% endfor %}
    </div>

    <form method="POST" action="{{ url_for('submit_answer') }}" id="word-order-form">
        <input type="hidden" name="answer" id="assembled-answer" value="">

        <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="clearAnswer()"
                    style="background: #f5f5f5; border: 1px solid #ccc; color: #555;">
                üóë Clear
            </button>
            <button type="submit" class="btn btn-primary btn-large" id="submit-btn" disabled
                    onclick="return prepareSubmit()">
                Submit Answer
            </button>
        </div>
    </form>

    <div class="button-group" style="margin-top: 10px;">
        <a href="{{ url_for('home') }}" class="btn btn-secondary"
           onclick="return confirm('Are you sure you want to exit? Your progress will be lost.')">üè† Home</a>
        <a href="{{ url_for(menu_route, level=level) }}" class="btn btn-secondary"
           onclick="return confirm('Are you sure you want to go back? Your progress will be lost.')">‚Ü©Ô∏è Back to Menu</a>
        <a href="{{ url_for('skip_question') }}" class="btn btn-secondary"
           style="background: #f5f5f5; border: 1px solid #ccc; color: #555; font-size: 0.9rem;">
            ‚è≠ Skip
        </a>
    </div>
</div>

<div class="text-center">
    <p style="color: #999; font-size: 0.85rem;">
        üí° Tip: Click a word to add it ‚Äî click a placed word to return it to the bank.
    </p>
</div>

<script>
    const selectedWords = [];  // ordered list of word strings
    const chipRefs = {};       // word string ‚Üí chip element (only works for unique words)

    function selectWord(btn) {
        const word = btn.dataset.word;
        // Move chip from bank to answer area
        btn.style.display = 'none';
        selectedWords.push(word);
        renderAnswerArea();
        updateSubmitButton();
    }

    function removeWord(index) {
        const word = selectedWords.splice(index, 1)[0];
        // Restore the first hidden chip with this word
        const chips = document.querySelectorAll('#word-bank .word-chip');
        for (const chip of chips) {
            if (chip.dataset.word === word && chip.style.display === 'none') {
                chip.style.display = '';
                break;
            }
        }
        renderAnswerArea();
        updateSubmitButton();
    }

    function renderAnswerArea() {
        const area = document.getElementById('answer-area');
        const placeholder = document.getElementById('answer-placeholder');

        if (selectedWords.length === 0) {
            placeholder.style.display = '';
            // Remove any placed chips
            area.querySelectorAll('.placed-chip').forEach(el => el.remove());
            return;
        }

        placeholder.style.display = 'none';
        // Clear placed chips and re-render
        area.querySelectorAll('.placed-chip').forEach(el => el.remove());
        selectedWords.forEach((word, idx) => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'placed-chip';
            chip.textContent = word;
            chip.style.cssText = 'padding: 10px 16px; background: #d5f5e3; border: 2px solid #27ae60; ' +
                'border-radius: 20px; cursor: pointer; font-size: 1rem; color: #1e8449; transition: all 0.2s;';
            chip.onclick = () => removeWord(idx);
            chip.title = 'Click to remove';
            area.appendChild(chip);
        });
    }

    function clearAnswer() {
        // Return all placed words to bank
        while (selectedWords.length > 0) {
            removeWord(0);
        }
    }

    function updateSubmitButton() {
        const btn = document.getElementById('submit-btn');
        const totalWords = document.querySelectorAll('#word-bank .word-chip').length;
        const placedCount = selectedWords.length;
        btn.disabled = placedCount === 0;
    }

    function prepareSubmit() {
        document.getElementById('assembled-answer').value = selectedWords.join(' ');
        return true;
    }
</script>
{% endblock %}
