{% extends "base.html" %}

{% block title %}Question {{ question_num }} of {{ total_questions }}{% endblock %}

{% block content %}
<div class="question-card">
    <div class="question-header">
        Question {{ question_num }} of {{ total_questions }}
    </div>

    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ (question_num / total_questions * 100) }}%"></div>
    </div>

    {# Strip the irregular flag from the raw question text first #}
    {% if ' ‚ö†Ô∏è irregular verb' in question.question %}
        {% set raw_question = question.question.replace(' ‚ö†Ô∏è irregular verb', '') %}
        {% set is_irregular = true %}
    {% else %}
        {% set raw_question = question.question %}
        {% set is_irregular = false %}
    {% endif %}

    {# Parse conjugation questions into structured components #}
    {% set parsed = raw_question | parse_conjugate_question %}

    <div class="question-text">
        {{ parsed.main }}
    </div>

    <form method="POST" action="{{ url_for('submit_answer') }}">
        {% if question.type == 'multiple_choice' or question.type == 'auxiliary_choice' %}
            <!-- Multiple choice options -->
            <div style="margin-bottom: 20px;">
                {% for choice in question.choices %}
                    <label style="display: block; padding: 15px; margin-bottom: 10px; background: white; border: 2px solid var(--medium-gray); border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <input type="radio" name="answer" value="{{ choice }}" required style="margin-right: 10px;">
                        <span style="font-size: 1.1rem;">{{ choice }}</span>
                    </label>
                {% endfor %}
            </div>
        {% else %}
            <!-- Text input for other question types -->
            <input type="text"
                   name="answer"
                   class="answer-input"
                   placeholder="Type your answer..."
                   autocomplete="off"
                   autofocus
                   required>
        {% endif %}

        {# Hint chips: English meaning, irregular warning, and activity-specific hints #}
        {% if parsed.english or is_irregular or question.hint %}
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0 18px 0;">
            {% if parsed.english %}
            <span style="background: #eaf4fb; color: #2471a3; border: 1px solid #aed6f1; border-radius: 20px; padding: 4px 12px; font-size: 0.82rem;">
                üá¨üáß {{ parsed.english }}
            </span>
            {% endif %}
            {% if is_irregular %}
            <span style="background: #fef9e7; color: #b7770d; border: 1px solid #f9e79f; border-radius: 20px; padding: 4px 12px; font-size: 0.82rem;">
                ‚ö†Ô∏è irregular verb
            </span>
            {% endif %}
            {% if question.hint %}
            <span style="background: #eafaf1; color: #1e8449; border: 1px solid #a9dfbf; border-radius: 20px; padding: 4px 12px; font-size: 0.82rem;">
                {{ question.hint }}
            </span>
            {% endif %}
        </div>
        {% endif %}

        <div class="button-group">
            <button type="submit" class="btn btn-primary btn-large">Submit Answer</button>
        </div>
        <div class="button-group" style="margin-top: 10px;">
            <a href="{{ url_for('home') }}" class="btn btn-secondary" onclick="return confirm('Are you sure you want to exit? Your progress will be lost.')">üè† Home</a>
            <a href="{{ url_for(menu_route, level=level) }}" class="btn btn-secondary" onclick="return confirm('Are you sure you want to go back? Your progress will be lost.')">‚Ü©Ô∏è Back to Menu</a>
        </div>
    </form>
</div>

<div class="text-center">
    <p style="color: #999; font-size: 0.85rem;">
        üí° Tip: You don't need to type accents (√†, √®, √¨, √≤, √π). Just type regular letters!
    </p>
</div>

<script>
// Auto-submit on Enter
document.querySelector('form').addEventListener('submit', function(e) {
    const input = document.querySelector('.answer-input');
    if (input.value.trim() === '') {
        e.preventDefault();
        alert('Please enter an answer');
    }
});
</script>
{% endblock %}
